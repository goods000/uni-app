!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.emedia=t():e.emedia=t()}(window,(function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(i,o,function(t){return e[t]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(module,exports){var CHARS;function Util(){}CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),Math.uuid=function(e,t){var n,i,o=CHARS,r=[];if(t=t||o.length,e)for(n=0;n<e;n++)r[n]=o[0|Math.random()*t];else for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",n=0;n<36;n++)r[n]||(i=0|16*Math.random(),r[n]=o[19==n?3&i|8:i]);return r.join("")},Math.uuidFast=function(){for(var e,t=CHARS,n=new Array(36),i=0,o=0;o<36;o++)8==o||13==o||18==o||23==o?n[o]="-":14==o?n[o]="4":(i<=2&&(i=33554432+16777216*Math.random()|0),e=15&i,i>>=4,n[o]=t[19==o?3&e|8:e]);return n.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t});var Logger=function(e){var t=this,n=0,i=1,o=2,r=3,s=4,a=5,c=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"];function d(n,i){try{!function(n,i){if(global.emedia&&global.emedia.LOG_LEVEL&&n<global.emedia.LOG_LEVEL)return;var o=[];o.push(n),e&&o.push(e);for(var r=0;r<i.length;r++)o.push(i[r]&&i[r]._toString?i[r]._toString.call(i[r]):i[r]);t._log.apply(t,o)}(n,i)}catch(e){if(console){if(console.error)return void console.error(e);if(console.log)return void console.log(e)}throw e}}function u(){if(!(global.emedia._logContextIndex<0)&&global.emedia._logContext&&global.emedia._logContext instanceof Array){var e=global.emedia._logContextIndex%global.emedia._logContext.length,t=global.emedia._logContext[e];t&&t instanceof Array||(t=global.emedia._logContext[e]=[]);var n=[];n.push(global.emedia._logContextIndex);var i,o=new Date;"function"==typeof o.toLocaleString?n.push(o.toLocaleString()):o.toJSON?n.push(o.toJSON()):o.toISOString?n.push(o.toISOString()):n.push(o+"");for(var r=0;r<arguments.length;r++){var s=arguments[r];"string"!=typeof s?s?"string"!=typeof s.message?"function"!=typeof s.message?"string"!=typeof s.stack?s.event&&"function"==typeof s.event.toString?n.push(s.event.toString()):s.event&&"function"==typeof s.event.toString?n.push(s.event.toString()):"string"!=typeof s.candidate?"string"!=typeof s.sdp?isPlainObject(s)?n.push(JSON.stringify(s)):n.push(String(s)):n.push(s.sdp):n.push(s.candidate):n.push(s.stack):n.push(s.message()):n.push(s.message):n.push(s):n.push(s)}if(global.emedia.config.loglastStoreArray&&t.push(i=n.join(" ")),"function"==typeof global.emedia.config.onSdkLog)try{i||(i=n.join(" ")),global.emedia.config.onSdkLog(i)}catch(e){console.error(e)}}}function l(){try{u.apply(null,arguments)}catch(e){console.warn(e)}}this._log=function(){var e=arguments[0];e=arguments[0]=c[e],global.emedia._logContext&&l.apply(null,arguments),!0===global.emedia.config.consoleLogger&&(global.emedia&&global.emedia.isElectron?console.log.apply(console,arguments):console&&e&&(console[e.toLowerCase()]||console.warn).apply(console,arguments))},this.log=function(){this._log&&d(o,arguments)},this.trace=function(){this._log&&d(n,arguments)},this.debug=function(){this._log&&d(i,arguments)},this.info=function(){this._log&&d(o,arguments)},this.warn=function(){this._log&&d(r,arguments)},this.error=function(){this._log&&d(s,arguments)},this.fatal=function(){this._log&&d(a,arguments)}};Logger.prototype.count=function(){if(global.emedia._logContext){global.emedia._logContextIndex++;var e=global.emedia._logContextIndex%global.emedia._logContext.length;0===e&&0!==global.emedia._logContextIndex&&(global.emedia._logContext.loadlogs=global.emedia._logContext[e]),global.emedia._logContext[e]=[]}},Util.prototype.logger=new Logger,Util.prototype.tagLogger=function(e){return new Logger(e)},Util.prototype.parseJSON=function(e){return JSON.parse(e)};var stringifyJSON=Util.prototype.stringifyJSON=function(e){return JSON.stringify(e)},class2type={},toString=class2type.toString,hasOwn=class2type.hasOwnProperty,fnToString=hasOwn.toString,ObjectFunctionString=fnToString.call(Object),isPlainObject=Util.prototype.isPlainObject=function(e){var t,n;return!(!e||"[object Object]"!==toString.call(e)||"<JSAPI-Auto Javascript Object>"===e.toString()||"[object IFBComJavascriptObject]"===e.toString())&&(!(t=Object.getPrototypeOf(e))||"function"==typeof(n=hasOwn.call(t,"constructor")&&t.constructor)&&fnToString.call(n)===ObjectFunctionString)};Util.prototype.isArray=Array.isArray,Util.prototype.isEmptyObject=function(e){var t;for(t in e)return!1;return!0},Util.prototype.type=function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?class2type[toString.call(e)]||"object":typeof e},Util.prototype.extend=function(){var e,t,n,i,o,r,s=this,a=arguments[0]||{},c=1,d=arguments.length,u=!1;for("boolean"==typeof a&&(u=a,a=arguments[c]||{},c++),"object"==typeof a||s.isFunction(a)||(a={}),c===d&&(a=this,c--);c<d;c++)if(null!=(e=arguments[c]))for(t in e)n=a[t],a!==(i=e[t])&&(u&&i&&(s.isPlainObject(i)||(o=s.isArray(i)))?(o?(o=!1,r=n&&s.isArray(n)?n:[]):r=n&&s.isPlainObject(n)?n:{},a[t]=s.extend(u,r,i)):void 0!==i&&(a[t]=i));return a},Util.prototype.removeAttribute=function(e,t){if(null!=e){var n=e[t];return delete e[t],n}},Util.prototype.prototypeExtend_000=Util.prototype.classExtend=function(){var e,t=this;function n(){for(var e=0;e<arguments.length;e++){var n=arguments[e]||{};t.extend(!0,this,n)}this.__init__&&this.__init__.apply(this,arguments)}for(var i=0;i<arguments.length;i++){var o=arguments[i]||{};"function"==typeof o?e?(o.constructor=e,o.__proto__=e.prototype):e=o:t.extend(!0,n.prototype,o)}return e&&(n.prototype.__proto__=e.prototype),e&&(n.prototype.constructor=e),n.extend||(n.extend=function(e){return t.prototypeExtend(n,e)}),n},Util.prototype.prototypeExtend=Util.prototype.classExtend=function(){var e=this;function t(){for(var t=0;t<arguments.length;t++){var n=arguments[t]||{};e.extend(!0,this,n)}this.__init__&&this.__init__.apply(this,arguments)}for(var n=0;n<arguments.length;n++){var i=arguments[n]||{};"function"==typeof i&&(i=i.prototype),e.extend(!0,t.prototype,i)}return t.extend||(t.extend=function(n){return e.prototypeExtend(t,n)}),t},Util.prototype.hasLocalStorage=function(e){return null!=localStorage.getItem(e)&&"{}"!=localStorage.getItem(e)},Util.prototype.toggleClass=function(e,t){e.hasClass(t)?e.removeClass(t):e.addClass(t)},Util.prototype.setCookie=function(e,t,n){var i=new Date;i.setTime(i.getTime()+60*n*60*1e3),document.cookie=e+"="+escape(t)+";expires="+i.toGMTString()},Util.prototype.getCookie=function(e){var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null},Util.prototype.forEach=function(e,t){if(e&&!(this.isArray(e)&&0===e.length||void 0!==e.length&&0===e.length))if(e.length)for(var n=0;n<e.length;n++)t(n,e[n]);else if(e&&!this.isEmptyObject(e)){e=e||{};var i=this.extend(!1,{},e);for(var o in i)t(o,e[o])}},Util.prototype.isInt=function(e){return Number(e)===e&&e%1==0},Util.prototype.isFloat=function(e){return Number(e)===e&&e%1!=0},Util.prototype.list=function(){var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);return e},Util.prototype.addEvent=function(e,t,n){if(e.attachEvent)return e.attachEvent("on"+t,n);if(e.addEventListener)return e.addEventListener(t,n,!1);throw"Handler could not be attached"},Util.prototype.removeEvent=function(e,t,n){if(e.detachEvent)return e.detachEvent("on"+t,n);if(e.removeEventListener)return e.removeEventListener(t,n,!1);throw"Handler could not be removed"},Util.prototype.stopEvent=function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault?e.preventDefault():e.returnValue=!1},Util.prototype.getDomPageRect=function(e){var t=e.getBoundingClientRect();return{x:t.left+(global.pageXOffset||global.document.documentElement.scrollLeft),y:t.top+(global.pageYOffset||global.document.documentElement.scrollTop),width:t.width||e.offsetWidth,height:t.height||e.offsetHeight}},Util.prototype.getEventElementXY=function(e,t,n){var i,o,r=(e=e||global.event).changedTouches?e.changedTouches[0]:e.touches?e.touches[0]:e;null!=r.pageX&&null!=r.pageY?(i=r.pageX,o=r.pageY):null!=r.clientX&&null!=r.clientY&&(i=r.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,o=r.clientY+document.body.scrollTop+document.documentElement.scrollTop);var s=this.getDomPageRect(t),a=i-s.x,c=o-s.y;return(0===n||null==n)&&(n=1),{x:Math.round(Math.max(Math.min(a,s.width-1),0)/n),y:Math.round(Math.max(Math.min(c,s.height-1),0)/n),width:Math.round(s.width/n),height:Math.round(s.height/n),realX:a,realY:c}},Util.prototype.targetDOM="object"==typeof HTMLElement?function(e){return e instanceof HTMLElement}:function(e){return e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName},Util.prototype.cloneCSS=function(e,t){var n=global.getComputedStyle&&global.getComputedStyle(e,null)||e.currentStyle;for(var i in n){var o=n[i];/^[a-z]/i.test(i)&&[null,"",void 0].indexOf(o)<0&&(t.style[i]=o)}},Util.prototype.canYield=function(){try{return eval("!!Function('yield true;')().next()")}catch(e){return!1}}(),Util.prototype.getRtcId=function(){var e="abcdefghijklmnopqrstuvwxyz".split(""),t=[];this.num||(this.num=0),this.num++;for(var n=0;n<3;n++)t[n]=e[parseInt(Math.random()*e.length)];return"wx-"+this.num.toString()+"-"+t.join("")},Util.prototype.fetch=function(e,t){return new Promise((function(n,i){global.request({url:e||"",method:t.method||"GET",data:t.data||{},header:{"content-type":"application/json"},success(e){n(e)},fail(e){i(e)}})}))};var PLATFORM={WX:"wx",UNI:"uni"},hasMiniBaseEvent=function(e){for(var t=["canIUse","getSystemInfo"],n=0,i=t.length;n<i;n++){if(!e[t[n]])return!1}return!0},isFromUniappEnv=function(){return!("undefined"==typeof uni||!hasMiniBaseEvent(uni))};if(Util.prototype.getEnvInfo=function(){return isFromUniappEnv()?{platform:PLATFORM.UNI,global:uni}:{platform:PLATFORM.WX,global:wx}},isFromUniappEnv())var global=uni;else var global=wx;module.exports=new Util},function(e,t,n){var i=n(0),o=(i.logger,i.getEnvInfo().global,i.prototypeExtend({msg:"",__init__:function(){this.day=new Date},execTime:function(){var e=this.day.getHours();e<10&&(e="0"+e);var t=this.day.getMinutes();t<10&&(t="0"+t);var n=this.day.getSeconds();return n<10&&(n="0"+n),e+":"+t+":"+n}})),r=o.extend({_webrtcDesc:function(){this.webrtc;return this.webrtc.getRtcId()}});e.exports={Exception:o.extend(),NetworkChanaged:o.extend({message:function(){return this.execTime()+" : Network chanage ("+this.preIp+" -> "+this.nowIp+")."}}),WSClose:o.extend({message:function(){var e=this.execTime()+" WSClose: Websocket close ("+(this.retry||0)+").";return this.online||(e+=" offline."),this.event&&(e+=" wscode: "+this.event.code),this.cause&&(e+=" cause: "+this.cause.message),this.url&&(e+=" url: "+this.url),e+=" retry: "+(this.retry||0),this.session&&this.session.getSessionId()&&(e=e+", sess = "+this.session.getSessionId()),e}}),WSError:o.extend({message:function(){var e=this.execTime()+" WSError: Websocket error. ready state:"+(this.event.srcElement&&this.event.srcElement.readyState||this.event.currentTarget.readyState)+". online = "+this.online;return this.session&&this.session.getSessionId()&&(e=e+", sess = "+this.session.getSessionId()),this.url&&(e+=" url: "+this.url),e}}),WSConnected:o.extend({message:function(){var e=this.execTime()+" WSConnected: Websocket success. ready state:"+(this.event.srcElement&&this.event.srcElement.readyState||this.event.currentTarget.readyState);return this.session&&this.session.getSessionId()&&(e=e+", sess = "+this.session.getSessionId()),e}}),ICEChanage:r.extend({message:function(){return this.execTime()+" ICEChanage: "+this._webrtcDesc()+" state: "+this.state}}),AddIceCandError:r.extend({message:function(){return this.execTime()+" AddIceCandError: "+this._webrtcDesc()+", add cand error"}}),ICEConnectFail:r.extend({message:function(){return this.execTime()+" ICEConnectFail: "+this._webrtcDesc()+" failed"}}),ICEConnected:r.extend({message:function(){return this.execTime()+" ICEConnected: "+this._webrtcDesc()+" connected"}}),ICEDisconnected:r.extend({message:function(){return this.execTime()+" ICEDisconnected: "+this._webrtcDesc()+" disconnected"}}),ICEClosed:r.extend({message:function(){return this.execTime()+" ICEClosed: "+this._webrtcDesc()+" closed"}}),ICERemoteMediaStream:r.extend({message:function(){return this.execTime()+" ICERemoteMediaStream: "+this._webrtcDesc()+" got remote stream"}}),StreamState:o.extend({message:function(){return this.execTime()+" StreamState:  stream "+this.stream.id+" state: "+this.state+" "+this.msg},iceFail:function(){this.state=1,this.msg="network anomaly. media lost"}}),OpenMediaError:o.extend({message:function(){return this.execTime()+" OpenMediaError:  open media error. caused by "+(this.event.name?this.event.name:this.event.message?this.event.message:this.event.toString())}}),Hangup:o.extend({message:function(){return this.self?"hangup id = "+(this.self.id||"--")+" reason："+(this.reason||0):this.execTime()+" Hangup: "+(this.parnter&&(this.parnter.name||this.parnter.id||" ")||"")+" hangup, reason："+(this.reason||0)}}),ServerRefuseEnter:o.extend({message:function(){return this.execTime()+" ServerRefuseEnter: server refuse, cause："+this.failed+", msg:"+(this.msg||"")}}),RspFail:o.extend({__init__:function(){this.day=new Date,this.failed=this.response.result,this.msg=this.response.msg||this.response.message||"--"},message:function(){return this.execTime()+" RspFail: "+this.request.tsxId+", "+(this.response.sessId||"--")+" op: "+this.request.op+", cause: "+this.failed+" "+this.msg}}),RecvResponse:o.extend({__init__:function(){this.day=new Date,this.failed=this.response.result,this.msg=this.response.msg},message:function(){return this.request?this.execTime()+" RecvResponse: "+(this.request&&this.request.tsxId)+", "+(this.response.sessId||"--")+" op: "+(this.request&&this.request.op)+", cause: "+this.failed+" "+this.msg:this.execTime()+" RecvMessage: "+(this.response&&this.response.tsxId)+", "+(this.response.sessId||"--")+" op: "+(this.response&&this.response.op)+" "+this.msg}}),EnterFail:o.extend({message:function(){return this.execTime()+" EnterFail: enter fail："+(this.cause?this.cause.message():"unkown")}}),EnterSuccess:o.extend({message:function(){return this.execTime()+" EnterSuccess: enter success "+(this.ip?", ip = "+this.ip:"")}}),PushSuccess:o.extend({message:function(){return this.execTime()+" PushSuccess: push success, streamId = "+this.stream.id+", "+this.stream.optimalVideoCodecs+", webrtc = "+this.stream.rtcId}}),PushFail:o.extend({message:function(){return this.execTime()+" PushFail: push fail, streamId = "+this.stream.id+", "+this.stream.optimalVideoCodecs+", webrtc = "+this.stream.rtcId+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),RemoteControlFail:o.extend({message:function(){return this.execTime()+" RemoteControlFail: "+(this.type||"remote control")+" fail, "+(this.stream?this.stream.id:"")+" failed = "+this.failed+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubSuccess:o.extend({message:function(){return this.execTime()+" SubSuccess: sub success, streamId = "+this.stream.id+", "+this.stream.vcodes+", webrtc = "+this.stream.rtcId}}),SubFail:o.extend({message:function(){return this.execTime()+" SubFail: sub fail, streamId = "+this.stream.id+", "+this.stream.vcodes+", webrtc = "+this.stream.rtcId+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubFailNotSupportVCodes:o.extend({message:function(){return this.execTime()+" SubFailNotSupportVCodes: sub fail, streamId = "+this.stream.id+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubFailSafariNotAllowSubBeforePub:o.extend({message:function(){return this.execTime()+" SubFailSafariNotAllowSubBeforePub: sub fail, streamId = "+this.stream.id+" cause：Safari without access to capture devices, WebKit only exposes Server Reflexive and TURN ICE candidates, which expose IPs that could already be gathered by websites."}}),SwitchVCodes:o.extend({message:function(){return this.execTime()+" SwitchVCodes: pub streamId = "+this.stream.id}}),CurrentCalling:o.extend({message:function(){return this.execTime()+" CurrentCalling: warn! current calling..."}}),OpenDesktopMedia:o.extend({message:function(){return this.execTime()+" OpenDesktopMedia: shared desktop, desktopStreamId = "+desktopStreamId}}),OpenDesktopMediaAccessDenied:o.extend({message:function(){return this.execTime()+" OpenDesktopMediaAccessDenied: shared desktop not allow"}}),ShareDesktopExtensionNotFound:o.extend({message:function(){return this.execTime()+" ShareDesktopExtensionNotFound: shared desktop plugin required"}}),OtherDeviceAnswer:o.extend({message:function(){return this.execTime()+" other device answer, webrtc = "+this.rtcId}}),AudioMixerStreamNotAllowSub:o.extend({message:function(){return this.execTime()+" audio mixer stream not allow sub, webrtc = "+this.rtcId+", streamId = "+this.stream.id}}),AudioMixerStreamNotAllowOnlySubVideo:o.extend({message:function(){return this.execTime()+" audio mixer stream not allow only sub video, webrtc = "+this.rtcId+", streamId = "+this.stream.id}}),AudioMixerStreamRepeatPublish:o.extend({message:function(){return this.execTime()+" audio mixer stream repeat publish"}})}},function(e,t,n){var i=n(0),o=i.tagLogger("mgr"),r=i.getEnvInfo().global,s=r.emedia.config.apiURL||"https://a1.easemob.com",a="/easemob/rtc/req/ticket",c="/easemob/rtc/req/ticket",d="/easemob/rtc/chanage/roles",u="/easemob/rtc/disband/conference",l="/easemob/rtc/kick/member",f="/easemob/rtc/select/confr";r.emedia=r.emedia||{};var m=function(){};function h(){this._confrs={},this._services={},this._events={},this._videos={},this.cattrs=[],this.setHost=function(e){s=e},this.__current_confrId="",this._confr=function(e){return e||(e=this.__current_confrId),this._confrs[e]||{}},this.exitConference=function(e){var t=this._services[e]||this._services[this._confrs.currentConf];if(t){this.__current_confrId="",t.exit();var n=this._confr(e);(n.members||[]).forEach(e=>{e.plugin&&e.plugin.stop()}),this._confrs[e]&&delete this._confrs[e],n=null}else o.warn("when exit. not found service.",e)},this.joinConferenceWithTicket=function(e,t,n){var i=this;return new Promise((function(o,s){var a=i._services[e]=new r.emedia.XService;a.setup(t,n),a.join((function(t){i.__current_confrId=e,o(t)}),(function(e){s(e)}))}))},this.joinConference=function(e,t,n){var i=this;return this.getConferenceTkt(e,t).then((function(t){i._confrs[t.data.confrId]||(i._confrs[t.data.confrId]=t.data);var o=t.data.ticket||"";return i.joinConferenceWithTicket(e,o,n)}))},this._onMemberJoined=function(e){if(e.sessId){var t=e.sessId,n=this._confr();n.sessId=t,n.rtcCfg=e.rtcCfg||"{relayOnly:false}",n.vcodes=e.vcodes}this.onMemberJoined(e)},this.onSoundChanage=m,this.onMediaChanaged=m,this.onMemberJoined=m,this.onMemberExited=m,this.onStreamAdded=m,this.onStreamRemoved=m,this.onRoleChanged=m,this.onConferenceExit=m,this.onConfrAttrsUpdated=m,this._onStreamRemoved=function(e){var t=this.__current_confrId,n=this._confr(t);n.othersInfo.forEach((t,i)=>{t.stream.id==e.id&&n.othersInfo.splice(i,1)}),this.onStreamRemoved(e)},this.onSignallingData=function(e){if(console.log((new Date).toLocaleString()+"*** 服务端返回信令：***** ",e),104==e.op||106==e.op){var t=e.rtcId,n=e.confrId||this.__current_confrId;this._confr(n).members.forEach(n=>{n.rtcId==t&&n.plugin.setData(e)})}}}function p(e){if(!e||0==Object.keys(e).length)return void console.warn("options is not have");if(!e.key)return void console.warn("options.key is not have");var t=e.key,n=e.val,o=e.success,r=e.error,a=e.type,c=e.confrId;if(!c)return void console.warn("please set_confr_attrs after joined");let{roleToken:d}=this._confrs[c];if(d){var u={roleToken:d,cattrs:[{key:t,val:n,op:a}],success:o,error:r},l=s+"/easemob/rtc/confr/attrs/update";e={method:"POST",data:JSON.stringify(u)};return i.fetch(l,e)}console.warn("roleToken is not have")}h.prototype.ConfrType={COMMUNICATION:10,COMMUNICATION_MIX:11,LIVE:12,P2P:13,INTERCOMM:14},h.prototype.Role={ADMIN:7,TALKER:3,AUDIENCE:1,HIDING:9},h.prototype._terminalInfo={browser:r.emedia.browser,browserVersion:r.emedia.browserVersion,version:r._emediaVersion||r.emedia.config.version,userAgent:r.emedia.config.userAgent},h.prototype.createUrl=function(e,t){return e},h.prototype.createConference=function(e,t,n,o){var c=s+a,d=this,u=r.WebIM.conn.context.accessToken||"",l="";if("[object Object]"===Object.prototype.toString.call(r.WebIM.conn.context.jid)){var f=r.WebIM.conn.context.jid;l=f.appKey+"_"+f.name+"@"+f.domain}else"[object String]"===Object.prototype.toString.call(r.WebIM.conn.context.jid)&&(l=r.WebIM.conn.context.jid.split("/")[0]);let m={method:"POST",data:{supportWechatMiniProgram:!0,role:r.emedia.config.useUniappPlugin?d.Role.ADMIN:d.Role.HIDING,uid:l,token:u,confrType:e||"",password:t||"",terminal:d._terminalInfo,rec:n||"",recMerge:o||""}};return i.fetch(c,m).then((function(e){return e.data.mixed=11===e.data.type||12===e.data.type,e.data.id=e.data.serverConfrId=e.data.confrId,d._confrs[e.data.confrId]=e.data,d.__current_confrId=e.data.confrId,d._confrs.currentConf=e.data.confrId,i.removeAttribute(e.data,"rtcCfg"),e}))},h.prototype.getConferenceTkt=function(e,t){var n=this,o=s+c,a=r.WebIM.conn.context.accessToken||"",d="";if("[object Object]"===Object.prototype.toString.call(r.WebIM.conn.context.jid)){var u=r.WebIM.conn.context.jid;d=u.appKey+"_"+u.name+"@"+u.domain}else"[object String]"===Object.prototype.toString.call(r.WebIM.conn.context.jid)&&(d=r.WebIM.conn.context.jid.split("/")[0]);var l=r.emedia.config.useUniappPlugin,f={method:"POST",data:{uid:d,token:a,confrId:e,password:t||"",role:l?n.Role.ADMIN:n.Role.HIDING}};return i.fetch(o,f).then(t=>(t.data.confrId=e,n.__current_confrId=e,t))},h.prototype.subStream=function(e){var t=this._videos.useUrl,n={method:"POST",data:{op:"subS",streamId:e||""}};return i.fetch(t,n)},h.prototype.pubStream=function(e){var t=this._videos.useUrl,n={method:"POST",data:{op:"pubS",rtcId:e||""}};return i.fetch(t,n)},h.prototype.grantRole=function(e,t,n){e=this._confr(e)||{};var o=s+d,r={method:"POST",data:{uids:t,role:n,roleToken:e.roleToken}};return i.fetch(o,r)},h.prototype.destroyConference=function(e){var t=this._confr(e),n=s+u,o={method:"POST",data:{roleToken:t&&t.roleToken}};return i.fetch(n,o)},h.prototype.kickMembersById=function(e,t){var n=this._confr(e),o=s+l,r={method:"POST",data:{uids:t,roleToken:n.roleToken}};return i.fetch(o,r)},h.prototype.getConferenceInfo=function(e,t){var n=r.WebIM.conn.context.accessToken||"",o="";if("[object Object]"===Object.prototype.toString.call(r.WebIM.conn.context.jid)){var a=r.WebIM.conn.context.jid;o=a.appKey+"_"+a.name+"@"+a.domain}else"[object String]"===Object.prototype.toString.call(r.WebIM.conn.context.jid)&&(o=r.WebIM.conn.context.jid.split("/")[0]);var c=s+f,d={method:"POST",data:{uid:o,token:n,confrId:e,password:t}};return i.fetch(c,d)},h.prototype.setConferenceAttrs=function(e){e.type="UPDATE",p.call(this,e)},h.prototype.deleteConferenceAttrs=function(e){e.type="DEL",p.call(this,e)},h.prototype.joinRoom=async function(e){let{roomName:t,password:n,role:o,config:a}=e,c=r.WebIM.conn.context.accessToken||"";var d="";if("[object Object]"===Object.prototype.toString.call(r.WebIM.conn.context.jid)){var u=r.WebIM.conn.context.jid;d=u.appKey+"_"+u.name+"@"+u.domain}else"[object String]"===Object.prototype.toString.call(r.WebIM.conn.context.jid)&&(d=r.WebIM.conn.context.jid.split("/")[0]);if(t)if(d)if(c)if(o)try{let e={roomName:t,password:n,memName:d,token:c,supportWechatMiniProgram:!0,useVCodes:["H264","VP8"],...a};const u=await function(e){var t=r.WebIM.conn.context.jid.appKey;if(t){var n=t.split("#")[0],o=t.split("#")[1],a=`${s}/${n}/${o}/conferences/room`,c={data:JSON.stringify(e),method:"POST"};return i.fetch(a,c)}console.warn("appkey is not defined")}(e);let{confrId:l}=u.data;try{let e={uid:d,token:c,confrId:l,password:n,role:o,terminal:this._terminalInfo,rec:a.rec,recMerge:a.recMerge,supportWechatMiniProgram:!0,useVCodes:["H264","VP8"]},t=await function(e){var t=s+"/easemob/rtc/req/ticket?_ct="+(new Date).getTime();e.region&&(t+=`&REGION=${e.region}`),e.confrId&&(t+=`&CONFRID=${e.confrId}`);var n={method:"POST",data:JSON.stringify(e)};return i.fetch(t,n)}(e);t.mixed=11===t.type||12===t.type,t.id=t.serverConfrId=t.confrId=l,this._confrs[l]=Object.assign(this._confrs[l]||{},t);try{let{ticket:e}=t.data,{nickName:n,ext:i}=a,{confrId:o,isCreator:r}=u.data;await this.joinConferenceWithTicket(o,e,{nickName:n,...i});let s={confrId:o};return r&&(s.isCreator=r),s}catch(e){return/cause: -523|cause:-523/.test(e.errorMessage)?{error:-523,message:"talker count limit"}:{error:-1,message:"joinRoom error",reaseon:e}}}catch(e){return e.response?JSON.parse(e.response):{error:-1,message:"joinRoom error",reaseon:e}}}catch(e){return e.response?JSON.parse(e.response):{error:-1,message:"joinRoom error",reaseon:e}}else console.warn("the role is required at joinRoom");else console.warn("the token is required at joinRoom");else console.warn("the memName is required at joinRoom");else console.warn("the roomName is required at joinRoom")},h.prototype.postMessage=function(e,t,n){if(!t||"object"!=typeof t)throw Error("the data must be an object");if("feature"!==t.detail.type)return;var i=this._services[e]||this._services[this._confrs.currentConf];let o=t.detail.data;if(console.log((new Date).toLocaleString()+"--- sdk postMessage -----",o),i.postMsg(o),102==o.op){e=e||this.__current_confrId;var r=this._confr(e),s=r.members||[];s.push({rtcId:o.rtcId,plugin:n}),r.members=s}},h.prototype.publish=function(e,t,n){e=e||this.__current_confrId;var i=this._confr(e),o=JSON.parse(i.ticket),r=o.tktId,s={uId:o.memName,tktId:r,sessId:i.sessId,rtcCfg:i.rtcCfg,vcodes:i.vcodes,reopen:n};console.log((new Date).toLocaleString()+" -----sdk 发布流 publish start() ------",s),t.start(s),i.myInfo={pusher:t}},h.prototype.subscribe=function(e,t,n,i){e=e||this.__current_confrId;var o=this._confr(e);console.log((new Date).toLocaleString()+"----- sdk subscribe play() ------",{streamId:t.id,sessId:o.sessId,rtcCfg:o.rtcCfg,uId:t.memName,reopen:i||!1},n),n.play({streamId:t.id,sessId:o.sessId,rtcCfg:o.rtcCfg,uId:t.memName,reopen:i||!1}),o.othersInfo||(o.othersInfo=[]),o.othersInfo.push({stream:t,player:n})},h.prototype.onReconnect=function(){confrId=this.__current_confrId;var e=this._confr(confrId);this.publish(confrId,e.myInfo.pusher,!0),e.othersInfo&&e.othersInfo.forEach(e=>{this.subscribe(confrId,e.stream,e.player,!0)})},h.prototype.onStateChange=function(e){if("object"==typeof e&&"bindstatechange"===e.type&&2004===e.detail.code){let n=e.detail.info,i=n.streamId,o=n.isPusher;confrId=this.__current_confrId;var t=this._confr(confrId);o?this.publish(confrId,t.myInfo.pusher,!0):t.othersInfo&&t.othersInfo.forEach(e=>{e.id===i&&this.subscribe(confrId,e.stream,e.player,!0)})}},e.exports=new h},function(e,t,n){var i=n(0),o=i.tagLogger("Webrtc"),r={},s=i.getEnvInfo().global,a={headerSection:null,audioSection:null,videoSection:null,_parseHeaderSection:function(e,t,n){var i=t;return-1===n||(i=-1===t?n:Math.min(t,n)),i>=0?e.slice(0,i):e},_parseAudioSection:function(e,t,n){var i=t;if(i>=0)return e.slice(i,n<i?e.length:n)},_parseVideoSection:function(e,t,n){var i=n;if(i>=0)return e.slice(i,t<i?e.length:t)},spiltSection:function(e){this._preSDP=e;var t=this._preAudioIndex=e.indexOf("m=audio"),n=this._preVideoIndex=e.indexOf("m=video");this.headerSection=this._parseHeaderSection(e,t,n),this.audioSection=this._parseAudioSection(e,t,n),this.videoSection=this._parseVideoSection(e,t,n)},setVideoBitrate:function(e){e&&this.videoSection&&(this.videoSection=this.setBitrate(this.videoSection,e))},setVideoMinBitrate:function(e){this.setAllFmtpBitrate({"x-google-min-bitrate":e})},setVideoMaxBitrate:function(e){this.setAllFmtpBitrate({"x-google-max-bitrate":e})},setVideoStartBitrate:function(e){this.setAllFmtpBitrate({"x-google-start-bitrate":e})},setAllFmtpBitrate:function(e){if(this.videoSection){var t={};Object.keys(e).forEach((function(n){var i=n+"="+e[n],o=new RegExp("(a=fmtp\\:\\d+\\s\\S*;?)("+n+"=\\d+)(;?\\S*)","g");t[n]={field:i,regex:o}})),this.videoSection=this.videoSection.replace(/(a=fmtp\:\d+[^\r\n]+)([\r\n]+)/g,(function(e,n,i){return n.indexOf("apt=")>=0?e:(Object.keys(t).forEach((function(e){var i=t[e],o=i.regex,r=i.field,s=n.replace(o,(function(e,t,n,i){return t+r+i}));s.indexOf(e)<0?(s.endsWith(";")||(s+=";"),n=s+r):n=s})),n+i)}))}},setFmtpBitrate:function(e,t){if(t&&this.videoSection){var n=e+"="+t,i=new RegExp("(a=fmtp\\:\\d+\\s\\S*;?)("+e+"=\\d+)(;?\\S*)","g");this.videoSection=this.videoSection.replace(/(a=fmtp\:\d+[^\r\n]+)([\r\n]+)/g,(function(t,o,r){var s=o.replace(i,(function(e,t,i,o){return t+n+o}));return s.indexOf(e)<0&&(s.endsWith(";")||(s+=";"),s+=n),s+r}))}},setAudioBitrate:function(e){e&&this.audioSection&&(this.audioSection=this.setBitrate(this.audioSection,e))},setBitrate0:function(e,t){return(e=e.replace(/(b=)(?:AS|TIAS)(\:)\d+/g,"$1AS$2"+t)).indexOf("b=AS")<0&&(e=e.replace(/(m=(?:audio|video)[^\r\n]+)([\r\n]+)/g,"$1$2b=AS:"+t+"$2")),e},setBitrate:function(e,t){let n="AS";return s.emedia.isFirefox&&(t=1e3*(t>>>0),n="TIAS"),(e=e.replace(/(b=)(?:AS|TIAS)(\:)\d+/g,"$1"+n+"$2"+t)).indexOf("b="+n+":")<0&&(e=e.indexOf("c=IN ")<0?e.replace(/(m=(?:audio|video)[^\r\n]+)([\r\n]+)/g,"$1$2b="+n+":"+t+"$2"):e.replace(/c=IN ([^\r\n]+)([\r\n]+)/,"c=IN $1$2b="+n+":"+t+"$2")),e},updateVideoSection:function(e,t){this.videoSection&&(this.videoSection=this.videoSection.replace(e,t))},updateAudioSection:function(e,t){this.audioSection&&(this.audioSection=this.audioSection.replace(e,t))},updateVideoSendonly:function(){this.videoSection&&(this.videoSection=this.videoSection.replace(/sendrecv/g,"sendonly"))},updateVideoRecvonly:function(){this.videoSection&&(this.videoSection=this.videoSection.replace(/sendrecv/g,"recvonly"))},updateAudioSendonly:function(){this.audioSection&&(this.audioSection=this.audioSection.replace(/sendrecv/g,"sendonly"))},updateAudioRecvonly:function(){this.audioSection&&(this.audioSection=this.audioSection.replace(/sendrecv/g,"recvonly"))},updateACodes:function(e){if(e&&this.audioSection){if("string"==typeof e)(n=[]).push(e),e=n;for(var t={},n=this._parseLine(this.audioSection,/a=rtpmap:(\d+) ([A-Za-z0-9]+)\/.*/gi),r=0;r<n.length;r++){var s=n[++r];t[n[++r]]=s}var a=[];for(r=0;r<e.length;r++){var c=t[e[r]];c&&a.push(c)}0==a.length&&(this._webrtc?o.warn("Not found acodes map",e,this._webrtc._rtcId,this._webrtc.__id):o.warn("Not found acodes map",e));var d=this.audioSection.indexOf("\r"),u=this.audioSection.substring(0,d),l=u.split(" ");Array.prototype.push.apply(a,l.slice(3));var f=[],m={};i.forEach(a,(function(e,t){0==f.length?(f.push(t),m[t]=!0):m[t]||(f.push(t),m[t]=!0)})),l.splice(3,l.length-3,f.join(" ")),u=l.join(" "),this._webrtc&&o.warn(u,this._webrtc._rtcId,this._webrtc.__id),this.audioSection=u+this.audioSection.substring(d)}},updateVCodes:function(e){if(e&&this.videoSection){if("string"==typeof e)(n=[]).push(e),e=n;for(var t={},n=this._parseLine(this.videoSection,/a=rtpmap:(\d+) ([A-Za-z0-9]+)\/.*/gi),r=0;r<n.length;r++){var s=n[++r];t[n[++r]]=s}var a=this._parseLine(this.videoSection,/a=fmtp:(\d+) .*profile-level-id=42e01f;?.*/gi);a&&a.length>=2&&(t.H264=a[1]);var c=[];for(r=0;r<e.length;r++){var d=t[e[r]];d&&c.push(d)}0==c.length&&(this._webrtc?o.warn("Not found vcodes map",e,this._webrtc._rtcId,this._webrtc.__id):o.warn("Not found vcodes map",e));var u=this.videoSection.indexOf("\r"),l=this.videoSection.substring(0,u),f=l.split(" ");Array.prototype.push.apply(c,f.slice(3));var m=[],h={};i.forEach(c,(function(e,t){0==m.length?(m.push(t),h[t]=!0):h[t]||(m.push(t),h[t]=!0)})),f.splice(3,f.length-3,m.join(" ")),l=f.join(" "),this._webrtc&&o.warn(l,this._webrtc._rtcId,this._webrtc.__id),this.videoSection=l+this.videoSection.substring(u)}},removeSSRC:function(e){for(var t=[],n=e.split(/a=ssrc:[^\n]+/g),i=0;i<n.length;i++)"\n"!=n[i]&&t.push(n[i]);return t.join("\n")},removeField_msid:function(e){for(var t=[],n=e.split(/a=msid:[^\n]+/g),i=0;i<n.length;i++)"\n"!=n[i]&&t.push(n[i]);e=t.join("\n"),t=[],n=e.split(/[\n]+/g);for(i=0;i<n.length;i++)"\n"!=n[i]&&t.push(n[i]);return t.join("\n")},updateHeaderMsidSemantic:function(e){var t="a=msid-semantic: WMS "+e,n=this.headerSection.split(/a=msid\-semantic: WMS.*/g),i=[];switch(n.length){case 1:i.push(n[0]);break;case 2:i.push(n[0]),i.push(t),i.push("\n");break;case 3:i.push(n[0]),i.push(t),i.push("\n"),i.push(n[2]),i.push("\n")}return this.headerSection=i.join("")},updateAudioSSRCSection:function(e,t,n,i){this.audioSection&&(this.audioSection=this.removeSSRC(this.audioSection)),this.audioSection&&(this.audioSection=this.removeField_msid(this.audioSection)),this.audioSection&&(this.audioSection=this.audioSection+this.ssrcSection(e,t,n,i))},updateVideoSSRCSection:function(e,t,n,i){this.videoSection&&(this.videoSection=this.removeSSRC(this.videoSection)),this.videoSection&&(this.videoSection=this.removeField_msid(this.videoSection)),this.videoSection&&(this.videoSection=this.videoSection+this.ssrcSection(e,t,n,i))},getUpdatedSDP:function(e){var t,n,i;if(void 0!==e&&null!=e||(e=this._preAudioIndex<this._preVideoIndex),this.videoSection&&this.videoSection.replace(/a=mid:([^\r\n]+)/,(function(e,n){return t=n,e})),this.audioSection&&this.audioSection.replace(/a=mid:([^\r\n]+)/,(function(e,t){return n=t,e})),e){var o=["a=group:BUNDLE"];this.audioSection&&o.push(n),this.videoSection&&o.push(t),i=this.headerSection.replace(/a=group:BUNDLE [^\r\n]+/,o.join(" ")),this.audioSection&&(i+=this.audioSection),this.videoSection&&(i+=this.videoSection)}else{o=["a=group:BUNDLE"];this.videoSection&&o.push(t),this.audioSection&&o.push(n),i=this.headerSection.replace(/a=group:BUNDLE [^\r\n]+/,o.join(" ")),this.videoSection&&(i+=this.videoSection),this.audioSection&&(i+=this.audioSection)}return i},parseMsidSemantic:function(e){var t=this._parseLine(e,/a=msid\-semantic:\s*WMS (\S+)/gi);return t&&2==t.length&&(this.msidSemantic={line:t[0],WMS:t[1]}),this.msidSemantic},ssrcSection:function(e,t,n,i){return["a=ssrc:"+e+" cname:"+t,"a=ssrc:"+e+" msid:"+n+" "+i,"a=ssrc:"+e+" mslabel:"+n,"a=ssrc:"+e+" label:"+i,""].join("\n")},parseSSRC:function(e){var t=new RegExp("a=(ssrc):(\\d+) (\\S+):(\\S+)","ig"),n=this._parseLine(e,t);if(n){for(var i={lines:[],updateSSRCSection:this.ssrcSection},o=0;o<n.length;o++){var r=n[o];if(r.indexOf("a=ssrc")>=0)i.lines.push(r);else switch(r){case"ssrc":case"cname":case"msid":case"mslabel":case"label":i[r]=n[++o]}}return i}},_parseLine:function(e,t){for(var n,i=[];null!=(n=t.exec(e));)for(var o=0;o<n.length;o++)i.push(n[o]);if(i.length>0)return i}},c=function(e,t){i.extend(this,a),this._webrtc=t,this.spiltSection(e)};c.isAudioVideo=function(e){return e.indexOf("m=audio")<e.indexOf("m=video")},c.isVideoPreAudio=function(e){var t=e.indexOf("m=audio"),n=e.indexOf("m=video");return t>=0&&n>=0&&n<t};var d=s.emedia.__rtc_globalCount=0,u=i.prototypeExtend({closed:!1,sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},offerOptions:{offerToReceiveAudio:!0,offerToReceiveVideo:!0},optimalVideoCodecs:null,optimalAudioCodecs:null,__init__:function(){this._rtcId||(this._rtcId="RTC"+d++),this.__id="_i_"+d++,this.__setRemoteSDP=!1,this.__tmpRemoteCands=[],this.__tmpLocalCands=[],this._rtcPeerConnection=null,this.cctx=this.__id,s.emedia&&s.emedia.config&&s.emedia.config.forceUseVideoCodecs&&s.emedia.config.forceUseVideoCodecs.length>0&&(this.optimalVideoCodecs=s.emedia.config.forceUseVideoCodecs),s.emedia&&s.emedia.config&&s.emedia.config.forceUseAudioCodecs&&s.emedia.config.forceUseAudioCodecs.length>0&&(this.optimalAudioCodecs=s.emedia.config.forceUseAudioCodecs),s.emedia&&s.emedia.config&&"number"==typeof s.emedia.config.forceVideoBitrate&&(this.vbitrate=s.emedia.config.forceVideoBitrate),s.emedia&&s.emedia.config&&"number"==typeof s.emedia.config.forceMinVideoBitrate&&(this.vminBitrate=s.emedia.config.forceMinVideoBitrate),s.emedia&&s.emedia.config&&"number"==typeof s.emedia.config.forceAudioBitrate&&(this.abitrate=s.emedia.config.forceAudioBitrate),o.info("Webrtc created. optimal video codecs:",this.optimalVideoCodecs,"audio codecs:",this.optimalAudioCodecs,"vbitrate:",this.vbitrate,"vminBitrate:",this.vminBitrate,"abitrate:",this.abitrate,this._rtcId,this.__id)},getRtcId:function(){return this._rtcId},iceState:function(){return this._rtcPeerConnection.iceConnectionState},setSubArgs:function(e){this.subArgs=e},getReceiversOfPeerConnection:function(){if(this._rtcPeerConnection&&"closed"!=this._rtcPeerConnection.iceConnectionState)return this._rtcPeerConnection.getReceivers()},updateRemoteBySubArgs:function(){this.subArgs&&this._remoteStream&&(s.emedia.enableVideoTracks(this._remoteStream,!(this.subArgs&&!1===this.subArgs.subSVideo)),s.emedia.enableAudioTracks(this._remoteStream,!(this.subArgs&&!1===this.subArgs.subSAudio)),o.info("enable tracks remote stream",this._remoteStream,this.subArgs,this._rtcId,this.__id,this.closed))},createRtcPeerConnection:function(e){var t=this;o.debug("begin create peer connection ......",t._rtcId,t.__id,t.closed),e||(e=t.iceServerConfig),e||s.emedia.isEdge?(e||(e={}),!e.iceServers&&(e.iceServers=[]),e.rtcpMuxPolicy="require",e.bundlePolicy="max-bundle",e.relayOnly&&(e.iceTransportPolicy="relay")):e=null,s.emedia&&s.emedia.config&&"function"==typeof s.emedia.config.reconfigRTCConfiguration&&(e=s.emedia.config.reconfigRTCConfiguration(e)),o.info("create pc, set config:",e,t._rtcId,t.__id,t.closed);var n=t._rtcPeerConnection=new RTCPeerConnection(e);function i(e){o.info("states: connectionState",n.connectionState,", iceConnectionState",n.iceConnectionState,"@",t._rtcId,t.__id,t.closed);try{var i=n.iceConnectionState||n.connectionState;"failed"!=n.connectionState&&"failed"!=n.iceConnectionState||(i="failed"),t.lastIceConnectionState!==i&&(t.lastIceConnectionState=i,t.onIceStateChange(i))}finally{}}n.__peerId=t._rtcId,o.debug("created local peer connection object",n,t._rtcId),n.onicecandidate=function(e){var n=e.candidate;if("icecandidate"!=e.type||n&&("string"!=typeof n.protocol||"tcp"!==n.protocol.toLowerCase())&&!/ TCP /.test(n.candidate)){if(!n.candidate)throw o.error("Not found candidate. candidate is error"),"Not found candidate. candidate is error,";if(n.cctx=t.cctx,!t.__setRemoteSDP)return(t.__tmpLocalCands||(t.__tmpLocalCands={})).push(n),void o.debug("On ICE candidate ok: but tmp buffer caused by not set remote sdp: ",n,t._rtcId,t.__id,t.closed);o.debug("On ICE candidate ok: ",n,t._rtcId,t.__id,t.closed),t._onIceCandidate(n)}else o.debug("On ICE candidate: drop",n,t._rtcId,t.__id,t.closed)},t.lastIceConnectionState="",n.onconnectionstatechange=i.bind(t),n.onicestatechange=i.bind(t),n.oniceconnectionstatechange=i.bind(t),n.onsignalingstatechange=function(e){o.info("states: signaling",n.signalingState,"@",t._rtcId,t.__id,t.closed)},null===n.ontrack&&t._onTrack&&(n.ontrack=function(e){t._onTrack(e)}),n.onaddstream=function(e){t._onGotRemoteStream(e)}},addTrack:function(e,t){var n=this;e.forEach((function(e){n._rtcPeerConnection.addTrack(e,t),o.debug("Added track(",e.id,e.kind,e.label,") of stream(",t.id,") to RtcPeerConnection",n._rtcId,n.__id,n.closed)}))},setLocalStream:function(e){var t=this;if(t._localStream=e,t._rtcPeerConnection.addTrack)e.getTracks().forEach((function(n){t._rtcPeerConnection.addTrack(n,e),o.debug("Added track(",n.enabled,n.id,n.kind,n.label,") of localStream(",e.id,") to RtcPeerConnection",t._rtcId,t.__id,t.closed)}));else{t._rtcPeerConnection.addStream(e);var n=e.getVideoTracks(),i=e.getAudioTracks();n&&n.length>0&&o.debug("RtcPeerConnection video: ",n[0].enabled,n[0].id,n[0].kind,n[0].label,t._rtcId,t.__id,t.closed),i&&i.length>0&&o.debug("RtcPeerConnection audio: ",i[0].enabled,i[0].id,i[0].kind,i[0].label,t._rtcId,t.__id,t.closed)}o.debug("Added local stream to RtcPeerConnection",e.id,e.active,t._rtcId,t.__id,this.closed)},removeStream:function(e){this._rtcPeerConnection.removeStream(e),o.debug("Remove stream from RtcPeerConnection",e,self._rtcId,self.__id,this.closed)},getLocalStream:function(){return this._localStream},getRemoteStream:function(){return this._remoteStream},createOffer:function(e,t){var n=this;o.debug("createOffer start...",n.offerOptions,n._rtcId,n.__id);var r=i.extend({},n.offerOptions);return n.subArgs&&(r={offerToReceiveAudio:!0,offerToReceiveVideo:!0}),n._rtcPeerConnection.createOffer(r).then((function(t){if(n.offerDescription=t,s.emedia.isEdge&&(t.sdp=t.sdp.replace(/profile-level-id=[^;]+/,"profile-level-id=42e01f")),s.emedia.isFirefox?n.fireFoxOfferVideoPreAudio=n.__offerVideoPreAudio=c.isVideoPreAudio(t.sdp):n.__offerVideoPreAudio=c.isVideoPreAudio(t.sdp),t.sdp=t.sdp.replace(/m=video 0/g,"m=video 9"),o.warn("setLocalDescription. modify offer. if 'm=video 0' -> 'm=video 9'; if H264, 'profile-level-id=42e01f'",n._rtcId,n.__id),n.optimalVideoCodecs&&n.optimalVideoCodecs.length>0||n.optimalAudioCodecs&&n.optimalAudioCodecs.length>0||n.offerOptions&&(!1===n.offerOptions.offerToReceiveVideo||!1===n.offerOptions.offerToReceiveAudio)){var i=new c(t.sdp,n);n.optimalVideoCodecs&&i.updateVCodes(n.optimalVideoCodecs),n.optimalAudioCodecs&&i.updateACodes(n.optimalAudioCodecs),n.offerOptions&&!1===n.offerOptions.offerToReceiveVideo&&i.updateVideoSection(/a=sendrecv|a=recvonly/g,"a=sendonly"),n.offerOptions&&!1===n.offerOptions.offerToReceiveAudio&&i.updateAudioSection(/a=sendrecv|a=recvonly/g,"a=sendonly"),t.sdp=i.getUpdatedSDP()}o.debug("setLocalDescription start",n._rtcId,n.__id,n.closed,n.optimalVideoCodecs,n.optimalAudioCodecs),n._rtcPeerConnection.setLocalDescription(t).then(n._onSetLocalSessionDescriptionSuccess.bind(n),n._onSetSessionDescriptionError.bind(n,t)).then((function(){t.cctx=n.cctx,(e||n.onCreateOfferSuccess.bind(n))(t)}))}),t||n._onCreateSessionDescriptionError.bind(n,r))},createPRAnswer:function(e,t){var n=this;return o.info(" createPRAnswer start",n.closed,n.sdpConstraints),n._rtcPeerConnection.createAnswer(n.sdpConstraints).then((function(t){o.debug("_____________PRAnswer ",t.sdp,n._rtcId,n.__id,n.closed),t.type="pranswer",t.sdp=t.sdp.replace(/a=recvonly/g,"a=inactive");var i=new c(t.sdp,n);n.optimalVideoCodecs&&i.updateVCodes(n.optimalVideoCodecs),n.optimalAudioCodecs&&i.updateACodes(n.optimalAudioCodecs),t.sdp=i.getUpdatedSDP(),n.__prAnswerDescription=t,o.debug("inactive PRAnswer ",t.sdp,n._rtcId,n.__id,n.closed),o.debug("setLocalDescription start",t,n._rtcId,n.__id,n.closed),n._rtcPeerConnection.setLocalDescription(t).then(n._onSetLocalSessionDescriptionSuccess.bind(n),n._onSetSessionDescriptionError.bind(n,t)).then((function(){i.updateHeaderMsidSemantic("MS_0000"),i.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),i.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=i.getUpdatedSDP(),o.debug("Send PRAnswer ",t.sdp,n._rtcId,n.__id,n.closed),n.cctx&&(t.cctx=n.cctx),(e||n.onCreatePRAnswerSuccess.bind(n))(t)}))}),t||n._onCreateSessionDescriptionError.bind(n,n.sdpConstraints))},createAnswer:function(e,t){var n=this;return o.info("createAnswer start",n.closed,n.sdpConstraints),n._rtcPeerConnection.createAnswer(n.sdpConstraints).then((function(t){o.debug("_____________________Answer ",n._rtcId,n.__id,n.closed),t.type="answer";var i=new c(t.sdp,n);n.optimalVideoCodecs&&i.updateVCodes(n.optimalVideoCodecs),n.optimalAudioCodecs&&i.updateACodes(n.optimalAudioCodecs),s.emedia.supportPRAnswer?function(e){var n=e.parseMsidSemantic(e.headerSection);if(n){"*"==n.WMS&&e.updateHeaderMsidSemantic(n.WMS="MS_0000");var i=e.parseSSRC(e.audioSection),o=e.parseSSRC(e.videoSection);i&&e.updateAudioSSRCSection(1e3,"CHROME0000",n.WMS,i.label||"LABEL_AUDIO_1000"),o&&e.updateVideoSSRCSection(2e3,"CHROME0000",n.WMS,o.label||"LABEL_VIDEO_2000"),t.sdp=e.getUpdatedSDP()}}(i):t.sdp=i.getUpdatedSDP(),n.__answerDescription=t,o.debug("Answer ",n._rtcId,n.__id,n.closed),o.debug("setLocalDescription start",t,n._rtcId,n.__id,n.closed),n._rtcPeerConnection.setLocalDescription(t).then(n._onSetLocalSessionDescriptionSuccess.bind(n),n._onSetSessionDescriptionError.bind(n,t)).then((function(){s.emedia.supportPRAnswer&&(i.updateHeaderMsidSemantic("MS_0000"),i.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),i.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=i.getUpdatedSDP()),o.debug("Send Answer ",n._rtcId,n.__id,n.closed),n.cctx&&(t.cctx=n.cctx),(e||n.onCreateAnswerSuccess.bind(n))(t)}))}),t||n._onCreateSessionDescriptionError.bind(n,n.sdpConstraints))},_printStats:function(e){var t=this;t.confrAttendee&&s.emedia.config.remainLastStatsCount&&e&&e.getTracks().forEach((function(e){t._printTrackStats(e)}))},_printTrackStats:function(e){if(this.confrAttendee&&s.emedia.config.remainLastStatsCount){var t=this.confrAttendee._trackStats&&this.confrAttendee._trackStats[e.id];if(t){for(var n in t){var r=t[n];for(var a in r){var c=r[a];if(c)for(var d=c.curIndex,u=0;u<s.emedia.config.remainLastStatsCount;u++){var l=c[d=(d-1)%s.emedia.config.remainLastStatsCount];if(!l||void 0===l.data)break;o.info("[track]",this._rtcId,this.__id,e.kind,e.id,n,a,l.data,l.timestamp.toLocaleString())}}}i.removeAttribute(this.confrAttendee._trackStats,e.id)}}},close:function(e,t,n){var i=this;if(o.warn("webrtc closing",i._rtcId,i.__id,i.closed),i.__iceWaitIntervalId&&clearTimeout(i.__iceWaitIntervalId),!i.closed){t=!0===t,i.closed=!0;try{var r=i._localStream,a=i._remoteStream;function c(){if(i._rtcPeerConnection&&i._rtcPeerConnection.close(),o.info("peer connection close. it is",i._rtcPeerConnection&&i._rtcPeerConnection.__peerId),!n&&s.emedia.isSafari){i._rtcPeerConnection.iceConnectionState||i._rtcPeerConnection.connectionState;setTimeout((function(){i._rtcPeerConnection.iceConnectionState||i._rtcPeerConnection.connectionState;i.onIceStateChange&&i.onIceStateChange("closed")}),200)}}s.emedia.config.printStatsWhenPCClose?i.getStats(()=>{c(),r&&i._printStats(r),a&&i._printStats(a)}):c()}catch(e){o.warn(e)}finally{i._localStream&&!1===e&&s.emedia.stopTracks(i._localStream),i._remoteStream&&s.emedia.stopTracks(i._remoteStream),i._remoteStream=null,t||i.onClose&&i.onClose(),!0===n&&(o.info("Webrtc close. but retry build. will onIceStateChange(failed). eg. global.emedia.config iceWaitBuildMillis",i._rtcId,i.__id),i.onIceStateChange&&i.onIceStateChange("failed")),o.warn("webrtc closed. closed:",i._rtcId,i.__id,i.closed)}}},addIceCandidate:function(e){var t=i.isArray(e)?e:[e];if(emedia&&s.emedia.config&&"function"==typeof s.emedia.config.reChanageCandidate){for(var n=[],r=0;r<t.length;r++){e=t[r];var a=s.emedia.config.reChanageCandidate(e);a&&(o.info("Candidate rechanage. addons. it =",e,"->",a),i.isArray(a)?Array.prototype.push.apply(n,a):n.push(a))}t=n}this._addIceCandidate(t)},_addIceCandidate:function(e){if(this._rtcPeerConnection){o.debug("Add ICE candidate: ",e,this._rtcId,this.__id,this.closed);var t=i.isArray(e)?e:[e];
//!_util.isArray(candidate) && _cands.push(candidate);
if(!this.__setRemoteSDP)return Array.prototype.push.apply(this.__tmpRemoteCands||(this.__tmpRemoteCands={}),t),void o.debug("Add ICE candidate but tmp buffer caused by not set remote sdp: ",e,this._rtcId,this.__id,this.closed);for(var n=0;n<t.length;n++)if((e=t[n]).cctx&&e.cctx!=this.cctx)o.warn("addIceCandidate fail drop. cctx not equal. ",e,this._rtcId,this.__id,this.closed);else{if(!0===this.fireFoxOfferVideoPreAudio){var r=e.sdpMLineIndex;e.sdpMLineIndex=parseInt(e.sdpMid.replace(/[^0-9]*/,"")),o.warn("Firefox sdp section video pre audio, sdp mline index update ",r,"->",e.sdpMLineIndex)}e.candidate&&""!==e.candidate?this._rtcPeerConnection.addIceCandidate(new RTCIceCandidate(e)).then(this.onAddIceCandidateSuccess.bind(this),this._onAddIceCandidateError.bind(this,e)):o.warn("Add ICE candidate fail. drop it ",e,this._rtcId,this.__id,this.closed)}}},setRemoteDescription:function(e){return this._setRemoteDescription(e)},_setRemoteDescription:function(e){var t=this;if(t.__iceWaitIntervalId&&(clearTimeout(t.__iceWaitIntervalId),t.__iceWaitIntervalId=null,o.info("global.emedia.config iceWaitBuildMillis, clear ice wait interval id",t._rtcId,t.__id)),o.debug("setRemoteDescription start. ",t._rtcId,t.__id,t.closed),t.offerDescription){if(e.cctx&&e.cctx!=t.cctx)return void o.warn("setRemoteDescription fail drop. cctx not equal. ",e,t._rtcId,t.__id,t.closed);if(!0===t.fireFoxOfferVideoPreAudio||!0===t.__offerVideoPreAudio){var n=new c(e.sdp,t);e.sdp=n.getUpdatedSDP(!1),o.info("Remote sdp.2. switch audio video",e.sdp)}}else e.cctx&&(t.cctx=e.cctx);if(e.sdp=e.sdp.replace(/UDP\/TLS\/RTP\/SAVPF/g,"RTP/SAVPF"),o.warn("setRemoteDescription. UDP/TLS/RTP/SAVPF -> RTP/SAVPF; if firefox: switch audio video;",t._rtcId,t.__id),t.vbitrate||t.abitrate||t.vminBitrate){n=new c(e.sdp,t);t.vbitrate&&n.setVideoBitrate(t.vbitrate),t.vminBitrate&&n.setVideoMinBitrate(t.vminBitrate),t.abitrate&&n.setAudioBitrate(t.abitrate),o.warn("vbitrate = ",t.vbitrate,"vminBitrate = ",this.vminBitrate,", abitrate = ",t.abitrate,t._rtcId,t.__id),e.sdp=n.getUpdatedSDP(void 0===t.__offerVideoPreAudio||null===t.__offerVideoPreAudio?void 0:!t.__offerVideoPreAudio)}return o.debug("final remote sdp =",e.sdp,t._rtcId,t.__id),e=t.__remoteDescription=new RTCSessionDescription(e),t._rtcPeerConnection.setRemoteDescription(e).then((function(){t.__setRemoteSDP=!0,t._onSetRemoteSuccess.apply(t,arguments),t.__tmpLocalCands&&t.__tmpLocalCands.length>0&&(o.debug("After setRemoteDescription. send cands",t._rtcId,t.__id,t.closed),t._onIceCandidate(t.__tmpLocalCands),t.__tmpLocalCands=[]),t.__tmpRemoteCands&&t.__tmpRemoteCands.length>0&&(o.debug("After setRemoteDescription. add tmp cands",t._rtcId,t.__id,t.closed),t._addIceCandidate(t.__tmpRemoteCands),t.__tmpRemoteCands=[])}),t._onSetSessionDescriptionError.bind(t,e))},iceConnectionState:function(){return this._rtcPeerConnection.iceConnectionState},isConnected:function(){var e=this.lastIceConnectionState;return"connected"===e||"completed"===e},_onGotRemoteStream:function(e){var t=this;t._remoteStream=e.stream||e.streams[0],t._remoteStream._rtcId=t._rtcId,t._remoteStream.__rtc_c_id=t.__id,o.debug("On got remote stream",t._remoteStream?t._remoteStream.id+"_"+t._remoteStream.active:"null",t._rtcId,t.__id),t._remoteStream&&t._remoteStream.getTracks().forEach((function(e){o.debug("remote stream",t._remoteStream.id," track =",e.enabled,e.id,e.kind,e.label,t._rtcId,t.__id)})),t.updateRemoteBySubArgs(),this.onGotRemoteStream(this._remoteStream,e),o.debug("received remote stream, you will see the other.",t._rtcId,t.__id,this.closed)},_onSetRemoteSuccess:function(){o.info("onSetRemoteSuccess success",this._rtcId,this.__id),this.onSetRemoteSuccess.apply(this,arguments),this.offerDescription&&this.__remoteDescription&&this.__remoteDescription.sdp&&this._onAnswerCodes(this.__remoteDescription.sdp)},_onAnswerCodes:function(e){var t=new c(e,this);if(t.videoSection){var n=r.parseRtpParameters(t.videoSection);if(!n.codecs||0===n.codecs.length)return void o.info("not found any video codes. @ ",this._rtcId,this.__id);var s=[];i.forEach(n.codecs,(function(e,t){s.push(t.name)})),this.finalVCodeChoices=s,this.onVCodeChoices&&this.onVCodeChoices(s)}},onSetRemoteSuccess:function(){},onAddIceCandidateSuccess:function(){o.debug("addIceCandidate success",this._rtcId,this.__id)},_onAddIceCandidateError:function(e,t){o.error("failed to add ICE Candidate: "+t.toString(),", error candidate:",e,this._rtcId,this.__id),this.onAddIceCandidateError(t)},onAddIceCandidateError:function(e){},_onIceCandidate:function(e){o.debug("onIceCandidate:",e,this._rtcId,this.__id),this.onIceCandidate(e)},onIceCandidate:function(e){},onIceStateChange:function(e){o.debug("onIceStateChange : ICE state ",e)},_onCreateSessionDescriptionError:function(e,t){o.error("Failed to create session description: "+t.toString()," offerOptionsOrSDPConstraints:",e,this._rtcId,this.__id),this.onCreateSessionDescriptionError(t)},onCreateSessionDescriptionError:function(e){},onCreateOfferSuccess:function(e){o.debug("create offer success",this._rtcId,this.__id)},onCreatePRAnswerSuccess:function(e){o.debug("create answer success",this._rtcId,this.__id)},onCreateAnswerSuccess:function(e){o.debug("create answer success",this._rtcId,this.__id)},_onSetSessionDescriptionError:function(e,t){o.error("onSetSessionDescriptionError : Failed to set session description: ",t.toString(),this._rtcId,this.__id),e&&e.type&&e.sdp&&o.error("error sdp: type=",e.type,"sdp=",e.sdp,this._rtcId,this.__id),this.onSetSessionDescriptionError(t)},onSetSessionDescriptionError:function(e){},_onSetLocalSessionDescriptionSuccess:function(){var e=this;o.debug("onSetLocalSessionDescriptionSuccess : setLocalDescription complete",this._rtcId,this.__id),s.emedia.config.iceWaitBuildMillis&&(this.__iceWaitIntervalId&&clearTimeout(this.__iceWaitIntervalId),this.__iceWaitIntervalId=setTimeout((function(){o.info("global.emedia.config iceWaitBuildMillis, timeout, will close webrtc, will retry build by onIceStateChange(failed)",e._rtcId,e.__id),e.onIceStateChange&&e.onIceStateChange("failed")}),s.emedia.config.iceWaitBuildMillis),o.info("global.emedia.config iceWaitBuildMillis, start timeout",e._rtcId,e.__id)),this.onSetLocalSessionDescriptionSuccess(),this.__answerDescription&&this.__answerDescription.sdp&&this._onAnswerCodes(this.__answerDescription.sdp)},onSetLocalSessionDescriptionSuccess:function(){},onGotRemoteStream:function(e){o.debug("Got remote stream. ",e,this._rtcId,this.__id)},getStats:function(e){var t=this;return t._rtcPeerConnection?"function"!=typeof s.emedia.config.rtcStatsTypeMath?(o.warn("Get stats, but config rtcStatsTypeMather, ",this._rtcId,this.__id),void(e&&e())):void t._rtcPeerConnection.getStats(null).then((function(n){n.forEach((function(e,n){s.emedia.config.rtcStatsTypeMath(e,n)&&o.info("Rtc stats",e,t._rtcId,t.__id)})),e&&e(n)})):(o.warn("Get stats, but peer connection not exsits, ",this._rtcId,this.__id),void(e&&e()))}});e.exports=u},function(e,t,n){var i=n(0),o=i.getEnvInfo().global;o.emedia.subscribed=function(e){return!!e._located||(2===e.type?!(e._located||!e._webrtc):void 0!==e._webrtc)};var r=i.prototypeExtend({voff:0,aoff:0,__init__:function(){var e=this;if(!e._mediaStream)throw _logger.error("_mediaStream empty"),"_mediaStream empty";if(e.hasEnabledTracks(e._mediaStream)){if(!e.__audioContext)throw _logger.error("require audioContext"),"require audioContext";e.__soundMeter=new SoundMeter(e.__audioContext),e.__soundMeter.connectToSource(e._mediaStream,(function(t){if(t)throw t;e.__worked=e.__soundMeter.__worked=!0}))}},hasEnabledTracks:function(e){return o.emedia.hasEnabledTracks(e)},getSoundMeters:function(){if(this.__soundMeter&&this.__worked)if(this._mediaStream.active){if(this.hasEnabledTracks(this._mediaStream))return{instant:this.__soundMeter.instant,slow:this.__soundMeter.slow,clip:this.__soundMeter.clip}}else this.__worked&&this._finally()},_finally:function(){this.__soundMeter&&(this.__soundMeter.stop(),this.__worked=this.__soundMeter.__worked=!1)}});e.exports=i.prototypeExtend({__undefinedEQDelete:!0,Update:i.prototypeExtend({ifAoff:function(e){this.if("aoff",e)},ifVoff:function(e){this.if("voff",e)},ifMediaStream:function(e){this.if("mediaStream",e)},if:function(e,t){void 0!==this[e]&&t(this[e])}}),located:function(){return this._located||!1},webrtc:function(e){return e&&(this._webrtc=e),this},getMediaStream:function(){return void 0!==this.mediaStream?this.mediaStream:this._located?this._localMediaStream:this._webrtc&&(this._webrtc.getRemoteStream()||this._webrtc.getLocalStream())},requestFrame:function(){this._localMediaStream&&this._localMediaStream.getVideoTracks().forEach((function(e){"function"==typeof e.requestFrame&&e.requestFrame()}))},getLocalMediaStream:function(){return this._localMediaStream},getRemoteMediaStream:function(){if(this._webrtc&&void 0!==this._webrtc.getRemoteStream())return this._webrtc.getRemoteStream()},mutedNeed:function(){return this.mutedMuted||!1},ifMediaStream:function(e){void 0===this.mediaStream?this._located&&void 0!==this._localMediaStream?e(this._localMediaStream):this._located||!this._webrtc||void 0===this._webrtc.getRemoteStream()||e(this._webrtc.getRemoteStream()):e(this.mediaStream)},subscribed:function(){return o.emedia.subscribed(this)},updateAttributes:function(){for(var e=this,t=0;t<arguments.length;t++){var n=arguments[t];if(i.isPlainObject(n))for(var o in n){var r=n[o];e[o]=r}}},getHtmlDOMID:function(){return"_m_"+this.owner.id+"_s_"+this.id},MediaSoundMeter:r,StreamSoundMeter:i.prototypeExtend({__init__:function(){if(!this._stream||"function"!=typeof this._stream.getMediaStream)throw _logger.error("_stream empty or not found method getMediaStream"),"_stream empty or not found method getMediaStream";if(this._streamId=this._stream.id,this._streamCreateId=this._stream.__create_id,this._mediaStream=this._mediaStream,2===this._stream.type&&!this._stream.located()&&!this._webrtc)throw _logger.error("require webrtc. when type = 2 and not located"),"require webrtc. when type = 2 and not located";this.__mediaSoundMeter=this.__mediaSoundMeter||new r({__audioContext:this.__audioContext,_mediaStream:this._mediaStream}),this.__mediaSoundMeter.useCount=(this.__mediaSoundMeter.useCount||0)+1},onSoundMeters:function(e){var t={instant:0,slow:0,clip:0};if(this._stream.aoff)return this._finally(),e(t),t;if(2!==this._stream.type&&this._stream.subArgs&&void 0!==this._stream.subArgs.subSAudio&&!this._stream.subArgs.subSAudio)return this._finally(),e(t),t;if(0==this._stream.id||2===this._stream.type&&!this._stream.located()&&(!this._stream.subArgs||!this._stream.subArgs.subSAudio)){var n,r=this._webrtc.getReceiversOfPeerConnection();if(!r||0===r.length)return e(t),t;for(var s in r)"audio"===r[s].track.kind&&(n=r[s]);if(!n)return e(t),t;if("function"==typeof n.getContributingSources){var a,c=n.getContributingSources();if(o.emedia.config._printSoundData&&i.logger.debug(this._stream.id,this._stream.csrc,"rtpContributingSources ",c),!c||0===c.length)return e(t),t;for(var s in c)c[s].source==this._stream.csrc&&(a=this._stream.csrc);if(o.emedia.config._printSoundData&&i.logger.debug(this._stream.id,this._stream.csrc,"source ",a),void 0===a)return e(t),t}}var d=this.__mediaSoundMeter.getSoundMeters()||t,u=2===this._stream.type?this._webrtc:this._stream._webrtc;(o.emedia.meterWithTrackAudioLevel||0===d.instant)&&u&&!u.closed&&u._rtcPeerConnection&&u._rtcPeerConnection.getStats().then((function(t){t.size>0&&t.forEach((function(t){"track"!==t.type||"audio"!==t.kind&&"audio"!==t.trackIdentifier||(d.trackAudioLevel=t.audioLevel,d.trackTotalAudioEnergy=t.totalAudioEnergy,e(d))}))})),e(d)},_finally:function(){2===this._stream.type&&this._stream.located()&&this._remoteMediaSoundMeters&&this._remoteMediaSoundMeters._finally(),this.__mediaSoundMeter.useCount--,0===this.__mediaSoundMeter.useCount&&this.__mediaSoundMeter._finally()}})})},function(e,t,n){var i=n(0),o=i.getEnvInfo().global;console.log("global: ",o);var r=o.emedia={};if(o.emedia.util=i,console.log("global.emedia: ",o.emedia),o.emedia.config=function(e){for(var t in e=i.extend({},e))o.emedia.config[t]=e[t],"logLevel"===t&&(o.emedia.LOG_LEVEL=e[t]);o.emedia.config.loglastConfrCount&&!o.emedia._logContext&&(o.emedia._logContext=new Array(o.emedia.config.loglastConfrCount),o.emedia._logContextIndex=-1)},o.emedia.config({autoSub:!0,onlyEnter:!1,reconnect:13,reconnectDelay:3e3,getCopyIntervalMillis:3e4,checkConnectIntervalMillis:1e3,iceRebuildCount:3,iceRebuildIntervalMillis:500,enterTimeout:2e4,useRTCCfgIfServerReturn:!1,forceUseRTCCfgIfServerReturnWhenP2P:!0,allowRepeatAudioMixerPublish:!1,logVolumeWhenInstantGE:.5,getMediaMeterIntervalMillis:400,_useRequestAnimationFrame:!1,meterWithTrackAudioLevel:!1,judgeTalkingByInstantGE:.05,_printSoundData:!1,trackBufferSize:20,allowSendWhenLessThan:4,disableTrack:!1,ctrlCheckIntervalMillis:1e4,ctrlTimeoutMillis:3e4,_printDebugStats:!1,statsSeconds:10,remainLastStatsCount:120,loglastConfrCount:2,loglastStoreArray:!0,consoleLogger:!0,printStatsWhenPCClose:!0,rebuildPeerConnectionWhenNetworkChanaged:!0,rtcStatsTypeMath:function(e,t){switch(e.type){case"remote-candidate":case"local-candidate":case"track":case"stream":case"inbound-rtp":case"outbound-rtp":case"transport":return!0}return!1},apiURL:"https://a1.easemob.com",useUniappPlugin:!1}),i.logger.count(),o.emedia.AudioContext=o.AudioContext||o.webkitAudioContext,o.emedia.config.getMediaMeterIntervalMillis){try{"function"==typeof o.emedia.AudioContext?(o.emedia.__audioContext=new o.emedia.AudioContext,o.emedia.__usingWebAudio=!0):o.emedia.__usingWebAudio=!1}catch(e){o.emedia.__usingWebAudio=!1}o.emedia.__usingWebAudio||console.warn("'new AudioContext()' failed. can not know who talking."),o.emedia.__audioContext&&"suspended"===o.emedia.__audioContext.state&&console.warn("audioContext.state is suspended. can not know who talking. You can resume() global.emedia.__audioContext, but only in response to a tap.")}o.requestAnimationFrame&&o.emedia.config._useRequestAnimationFrame?o.emedia.requestAnimationFrame=function(e){o.requestAnimationFrame(e)}:o.emedia.requestAnimationFrame=function(e,t){return setTimeout(e,t||o.emedia.config.getMediaMeterIntervalMillis)},o.cancelAnimationFrame&&o.emedia.config._useRequestAnimationFrame?o.emedia.cancelAnimationFrame=function(e){o.cancelAnimationFrame(e)}:o.emedia.cancelAnimationFrame=function(e){clearTimeout(e)},o.emedia.stopAudioTracks=function(e){e&&e.getAudioTracks().forEach((function(t){t.stop(),i.logger.info("Media stream stop audio track. stream =",e.id,"track =",t.id,t.kind)}))},o.emedia.stopAndRemoveAudioTracks=function(e){var t=[];e&&e.getAudioTracks().forEach((function(n){n.stop(),t.push(n),i.logger.info("Media stream stop and remove audio tracks. stream =",e.id,"track =",n.id,n.kind)})),i.forEach(t,(function(t,n){e.removeTrack(n)}))},o.emedia.stopTracks=function(e){try{if(!e||!1===e.active)return void i.logger.debug("stream tracks had been stoped. it ",e&&e.id);e.getTracks().forEach((function(t){t.stop(),i.logger.info("Media stream stop track. stream =",e.id," track =",t.id,t.kind)})),e._bindAttendee&&(i.removeAttribute(e._bindAttendee._openedRtcMediaStreams,e.id),e._bindAttendee=null),i.logger.info("stream tracks stoped. it ",e.id)}catch(e){i.logger.error(e)}},o.emedia.enableVideoTracks=function(e,t){e&&e.getVideoTracks().forEach((function(n){if("function"==typeof n.enable)return n.enable(),i.logger.info("Media stream enable video track. stream =",e.id,"track =",n.kind,n.enabled,n.id),void(n.enabled===t||n.enable(t));n.enabled===t||(n.enabled=t)}))},o.emedia.enableAudioTracks=function(e,t){e&&e.getAudioTracks().forEach((function(n){if("function"==typeof n.enable)return n.enable(),i.logger.info("Media stream enable audio track. stream =",e.id,"track =",n.kind,n.enabled,n.id),void(n.enabled===t||n.enable(t));n.enabled===t||(n.enabled=t)}))},o.emedia.hasEnabledTracks=function(e){if(!e||"function"!=typeof e.getAudioTracks)return!1;if(!e.active)return!1;var t=e.getAudioTracks();if(0===t.length)return!1;for(var n in t)if("function"==typeof t[n].enable&&t[n].enable(),t[n].enabled)return!0;return!1},o.emedia.genReportName=function(){var e=o.emedia._lastSetupDate||new Date;return(o.emedia._lastSetupTktId||o.emedia._lastSetupConfr)+"_"+o.emedia._lastSetupMemName+"_"+e.getTime()+".docx"},o.emedia.getReportUploadUrl=function(e,t,n){var i=new XMLHttpRequest;i.open(e,t,!0),i.addEventListener("load",(function(e){n&&n(e)}),!1),i.send(null)},o.emedia.uploadReport=function(e,t,n,r,s,a){var c=o.emedia.genReport();if(c){"function"==typeof n&&(a=s,s=r,r=n,n=void 0);var d=new Blob([c],{type:"text/plain"}),u=new FormData;u.append(e,d,e),n&&"function"==typeof u.set&&i.forEach(n,(function(e,t){u.set(e,t)}));var l=new XMLHttpRequest;l.open("POST",t,!0),l.setRequestHeader("X-File-Name",e),a&&a(l),l.addEventListener("load",(function(n){console.info("log begin upload. result = ",n.currentTarget.status,e," > ",t),200===n.currentTarget.status?r&&r(n):s&&s(n)}),!1),l.send(u),console.info("log begin upload. ",e," > ",t)}else s&&s("not logs")},o.emedia.genReport=function(){if(o.emedia._logContext&&o.emedia._logContext instanceof Array&&!(void 0===o.emedia._logContextIndex||o.emedia._logContextIndex<0)){var e=0,t=o.emedia._logContextIndex;o.emedia._logContextIndex>=o.emedia._logContext.length&&(e=o.emedia._logContextIndex-o.emedia._logContext.length+1);for(var n="",i=e;i<=t;i++){var r=i%o.emedia._logContext.length;n+=o.emedia._logContext[r].join("\r\n")+"\r\n"}return o.emedia._logContext.loadlogs&&o.emedia._logContext.loadlogs instanceof Array&&(n+="-------------------------------------------------------------\r\n",n+=o.emedia._logContext.loadlogs.join("\r\n")+"\r\n"),n}},o.emedia.fileReport=function(){var e=o.emedia.genReport();if(e){var t=o.getFileSystemManager(),n=o.env.USER_DATA_PATH+"/"+o.emedia.genReportName();console.log("report:",e),t.writeFile({filePath:n,data:e,success:function(e){console.log("success",e),console.log(n),o.openDocument({filePath:n,success:function(e){console.log("打开文档成功",e)},fail:function(e){console.log("打开失败",e)}})},fail:function(e){console.log("fail",e)},complete:function(e){o.downloadFile({url:n,success:function(e){const t=e.tempFilePath;o.openDocument({filePath:t,fileType:"docx",success:function(e){console.log("打开文档成功",e)},fail:function(e){console.log("打开失败",e)}})}})}})}},o.emedia.config({globalConstraints:{}});var s=n(6),a=n(1);o.emedia.Webrtc=n(3),o.emedia.Service=s,o.emedia.XService=s,o.emedia.mgr=n(2),o.emedia.event=a,o.emedia.LOG_LEVEL=0,o.emedia.isFirefox="firefox"===o.emedia.browser,o.emedia.isChrome="chrome"===o.emedia.browser,o.emedia.isSafari="safari"===o.emedia.browser,o.emedia.isEdge="edge"===o.emedia.browser,o.emedia.youInSomeBrowsers=function(){return!1},o.emedia.requireTrustBeforeJoin=function(){return!1},o.emedia.isWebRTC=o.RTCPeerConnection&&/^https\:$/.test(o.location.protocol),(o.emedia.isChrome||o.emedia.isSafari)&&(o.emedia.supportPRAnswer=!0),o.emedia.supportPRAnswer=!1,o.emedia.config({baseAcptOps:[102,104,105,106,107,300,302,303,304,301,204,206,400,401,1001,100201,100202,100203]}),o.emedia.config({clientType:"MINI_PROGRAM",version:"v3.1.6",userAgent:"",acptOps:[1003]}),e.exports=r},function(e,t,n){var i=n(0),o=i.tagLogger("Service"),r=n(7),s=n(8),a=n(1),c=n(10),d=n(4),u=i.getEnvInfo().global;e.exports=i.prototypeExtend({__init__:function(){var e=this;if(o.warn("emedia version: ",u._emediaVersion||"unkown"),e.namespace=Math.uuidFast(),u.emedia.useCurrentXService=e,void 0===e.useRTCCfg&&(e.useRTCCfg=u.emedia.config.useRTCCfgIfServerReturn),"string"==typeof e.useRTCCfg&&(e.useRTCCfg=JSON.parse(e.useRTCCfg)),e.listeners)for(var t in e.listeners){var n=t,i=e.listeners[n];void 0!==i&&"onRecvRemoteMessage"!==n&&"onSoundChanage"!==n&&"onTalking"!==n&&(e.listeners["__user_"+n]=i,e.listeners[n]=function(t,n){return function(){o.info("sdk call user impl func. func=",t,e.current&&e.current.getMemberId()),n.apply(this,arguments)}}(n,i))}},AVPubstream:d.extend({__init__:function(){this.type=0,this._located=!0,this.mutedMuted=!0,this.constaints&&(this.constaints.video||(this.voff=1),this.constaints.audio||(this.aoff=1)),this.constaints||(this.constaints={audio:!0,video:!0}),u.emedia.config.maxVideoBitrate&&(this.vbitrate=u.emedia.config.maxVideoBitrate),u.emedia.config.maxAudioBitrate&&(this.abitrate=u.emedia.config.maxAudioBitrate)}}),AudioMixerPubstream:new d.extend({__init__:function(){if(this.type=2,this._located=!0,this.mutedMuted=!0,this.constaints||(this.constaints={audio:!0,video:!1}),this.constaints){var e=!!this.constaints.audio;this.constaints.video||(this.constaints.video=!1),this.constaints.video||(this.voff=1),this.constaints.audio||(this.aoff=1),!1===e&&(this.aoff=1)}u.emedia.config.maxVideoBitrate&&(this.vbitrate=u.emedia.config.maxVideoBitrate),u.emedia.config.maxAudioBitrate&&(this.abitrate=u.emedia.config.maxAudioBitrate)},onGotRemoteMediaStream:function(e){if(!this.remotePlayAudioObject){var t="__o_remote_play_audio_"+this.id,n=document.querySelector("#"+t);n||((n=document.createElement("audio")).style.display="none",n.id="__o_remote_play_audio_"+this.id,n.autoplay=!0,n.playsinline=!0,document.body.appendChild(n)),this.remotePlayAudioObject=n}this.remotePlayAudioObject.srcObject=e}}),ShareDesktopPubstream:d.extend({voff:0,__init__:function(){this.type=1,this._located=!0,this.mutedMuted=!0,this.constaints={audio:!this.aoff,video:!0},u.emedia.config.maxVideoBitrate&&(this.vbitrate=u.emedia.config.maxVideoBitrate),u.emedia.config.maxAudioBitrate&&(this.abitrate=u.emedia.config.maxAudioBitrate)}}),__assertCurrent:function(){if(!this.current)throw o.error("Please call global.emedia.service.setup(ticket)"),"Please call global.emedia.service.setup(ticket)";if(this.current.closed)throw o.error("current closed"),"current closed"},hasAudioMixers:function(){for(var e in this.__assertCurrent(),this.current.audioMixers){var t=this.current.audioMixers[e];if(t&&t.located())return!0}},getMediaDevices:function(e,t,n){"function"==typeof e&&(n=t,t=e,e=void 0),navigator.mediaDevices.enumerateDevices().then((function(n){for(var i=[],r=0;r!==n.length;++r){var s=n[r];e?e===s.kind?i.push(s):"audioinput"===s.kind||"audiooutput"===s.kind||"videoinput"===s.kind||o.info("Some other kind of source/device: ",s):i.push(s)}t&&t(i)})).catch((function(e){o.warn("navigator.getUserMedia error: ",e),n&&n(e)}))},attachSinkId:function(e,t){void 0!==e.sinkId?e.setSinkId(t).then((function(){o.info("Success, audio output device attached: "+t)})).catch((function(e){var t=e;"SecurityError"===e.name&&(t="You need to use HTTPS for selecting audio output device: "+e),o.warn(t)})):o.warn("Browser does not support output device selection.")},_stopTracks:function(e){u.emedia.stopTracks(e),e&&o.warn("Stream tracks stop. it = ",e)},_enableVideoTracks:function(e,t){u.emedia.enableVideoTracks(e,t)},_enableAudioTracks:function(e,t){u.emedia.enableAudioTracks(e,t)},openUserMedia:function(e){o.debug("begin open user media",e);var t=this;if(!e)throw o.error("require pubS"),"require pubS";return{then:function(n,i){function r(){n.apply(null,arguments);var i=e.localStream;i&&(i.oninactive=t._onStreamInactive.bind(t,e,i),i.onactive=t._onStreamActive.bind(t,e,i))}if(e instanceof t.AVPubstream)t._openCamera(e,r,i);else if(e instanceof t.ShareDesktopPubstream)t._openSharedDesktop(e,r,i);else{if(!(e instanceof t.AudioMixerPubstream))throw o.error("Unspported pubS"),"Unspported pubS";t._openCamera(e,r,i)}}}},_openSharedDesktop:function(e,t,n){var r,s=this;function c(e){var i={audio:!0};e.constaints&&("object"==typeof e.constaints.audio&&e.constaints.audio||e.constaints.audio||(i.audio=!1)),s.__getUserMedia(i,(function(n,i){var o=new MediaStream;o._located=!0,i&&i.getAudioTracks().forEach((function(e){o.addTrack(e)})),e.localStream&&e.localStream.getVideoTracks().forEach((function(e){o.addTrack(e)})),e.localStream=o,t&&t(s.current,o)}),n)}if(e._localMediaStream&&(r=e._localMediaStream.getVideoTracks())&&r.length>0)return e.localStream=e._localMediaStream,void(e.constaints.audio?c(e):t&&t(s.current,stream));__desktop.openDesktopMedia(e.screenOptions||["screen","window","tab"],(function(r){if(r instanceof a.OpenDesktopMedia){var d=r.desktopStreamId;o.warn("desktop streamId",d);var u={audio:!1,video:{mandatory:i.extend(e.mandatory||{},{chromeMediaSource:"desktop",chromeMediaSourceId:d}),optional:[]}};s.__getUserMedia(u,(function(n,i){e.localStream=i,e.constaints.audio?c(e):t&&t(s.current,i)}),n)}else s.current&&s.current.onEvent(new a.ShareDesktopExtensionNotFound({member:s.current})),n&&n(r)}))},_openCamera:function(e,t,n){var i=this,o=e.constaints||{audio:!0,video:!0};i.__getUserMedia(o,function(n,o){i.__controlStream(e,o),e.localStream=o,t&&t(i.current,o)}.bind(o),n)},__controlStream:function(e,t){u.emedia.enableVideoTracks(t,!e.voff),u.emedia.enableAudioTracks(t,!e.aoff)},__getUserMedia:function(e,t,n){o.debug("get user media. using constaints",e);var r,s=this;function c(e){o.debug("[WebRTC-API] getUserMedia() error: ",e),u.emedia.stopTracks(r),s.current&&s.current.onEvent(new a.OpenMediaError({member:s.current,event:e})),n&&n(new a.OpenMediaError({member:s.current,event:e}))}e=i.extend({},e),s.__sysGetUserMedia(e,(function(n){s.current&&!s.current.closed&&(s.current._openedRtcMediaStreams[n.id]=n,n._bindAttendee=s.current,n._bindAttendeeId=s.current.getMemberId(),o.info("stream bind attendee.",n.id,s.current.ticket&&s.current.ticket.id,s.current.getMemberId(),s.current.memName)),u.emedia._yetGetUserMedia=!0,r=n;var i=n.getVideoTracks(),a=n.getAudioTracks();if(i.length>0){var d=i[0];o.debug(n.id,"using video device: ",d.id,d.label,d.kind,d.enabled)}if(a.length>0){var l=a[0];o.debug(n.id,"using audio device: ",l.id,l.label,l.kind,l.enabled)}if(n._located=!0,"boolean"==typeof n.active&&!n.active)return o.error("media stream not active. it is",n.id),void c({constraint:e,name:"NotAllowedStreamNonactive",message:"stream non-active"});t&&t(s.current,n)}),c)},_onStreamInactive:function(e,t,n){var r=this;o.warn("media stream inactive. it =",t.id),e.onMediaInactive&&r.current&&i.forEach(r.current._cacheStreams,(function(i,o){o.located()&&o.localStream&&o.localStream.id===t.id&&(o._webrtc&&o._webrtc.closed||e.onMediaInactive.call(o,t,n,r))}))},_onStreamActive:function(e,t,n){var r=this;o.warn("media stream active. it =",t.id),e.onMediaActive&&r.current&&i.forEach(r.current._cacheStreams,(function(i,o){o.located()&&o.localStream&&o.localStream.id===t.id&&e.onMediaActive.call(o,t,n,r)}))},setup:function(e,t){var n=this;o.count(),o.debug("recv ticket",e,t),o.debug("use sdk version",u._emediaVersion);var r,a,d=t=t||{};if(i.isPlainObject(t))t=JSON.stringify(t);else try{d=JSON.parse(t)}catch(e){}"string"==typeof e&&(e=JSON.parse(e)),r=a=e.memName,u.emedia._lastSetupConfr=e.confrId,u.emedia._lastSetupMemName=a,u.emedia._lastSetupDate=new Date,u.emedia._lastSetupTktId=e.tktId;var l=(n.Attendee||s).extend(c);return n.current=new l({_service:n,service:n,autoSub:u.emedia.config.autoSub,getCopyIntervalMillis:u.emedia.config.getCopyIntervalMillis,sysUserId:r,memName:a,resource:n.resource,nickName:n.nickName,ticket:e,ext:t,extObj:d,sessionFactory:function(){return n.newSession(this,e)}},n.listeners||{})},getStreamById:function(e){var t=this.current&&this.current._cacheStreams[e];return t&&i.extend(!1,{},t)},getStreamsByRtcId:function(e){if(this.current&&this.current._cacheStreams){var t=[];return i.forEach(this.current._cacheStreams,(function(n,i){i.rtcId===e&&t.push(i)})),t}},getMemberById:function(e){var t=this.current&&this.current._cacheMembers[e];return t&&i.extend(!1,{},t)},exit:function(e){o.warn("User click exit ",e),this.current&&this.current.exit(e)},join:function(e,t){o.debug("begin join ...");if(this.__assertCurrent(),this.current._memberId)return o.warn("Had joined. igrone it"),void(e&&e(this.memId));this.current._session._sessionId=void 0,this.current.join(e,t)},withpublish:function(e){console.log("serveice withpublish");if(!e||!e.localStream)throw o.error("pubS null or stream not open"),"pubS null or stream not open";return this.__assertCurrent(),this.current._memberId?o.warn("Had joined. igrone it"):this.current._session._sessionId=void 0,this.current.withpublish(e)},push:function(e,t,n){o.debug("begin push ...");var i=this;if(2===arguments.length&&(n=t,t=void 0),!e||!e.localStream)throw o.error("pubS or stream open"),"pubS or stream open";i.__assertCurrent(),i.current.push(e,t,n,!1)},subscribe:function(e,t,n,r){var s=this;if(o.info("begin subscribe ",e,r),t&&i.isPlainObject(t)&&(r=t,t=n=void 0),n&&i.isPlainObject(n)&&(r=n,n=t,t=void 0),u.emedia.isSafari){var a={streamId:e,onSub:t,subfail:n,subArgs:r},c=s.__safari_subs||(s.__safari_subs=[]);function d(){try{var e=c.shift();e&&e.onSub&&e.onSub.apply(e,arguments)}finally{f()}}function l(){try{var e=c.shift();e&&e.subfail&&e.subfail.apply(e,arguments)}finally{f()}}function f(){c.length>0&&s.__subscribe(c[0].streamId,d,l,c[0].subArgs)}c.push(a),1===c.length&&f()}else s.__subscribe(e,t,n,r)},__subscribe:function(e,t,n,r){var s=this;s.__assertCurrent(),2==arguments.length&&(n=t,t=void 0),t&&i.isPlainObject(t)&&(r=t,t=void 0),n&&i.isPlainObject(n)&&(r=n,n=void 0),r||(r={subSVideo:!0,subSAudio:!0});s.current._cacheStreams[e];var a=s.current._getWebrtc(e),c=a&&a.isConnected(),d=c&&a.getRemoteStream();if(d&&(c=d.active)){var u=d.getAudioTracks().length,l=d.getVideoTracks().length;(u||!0!==r.subSAudio)&&(l||!0!==r.subSVideo)||(c=!1)}if(o.info("sub stream",e,", use prertcpeer =",c),c)return s.current.subscribeStream(a._rtcId,e,n,r,t),void(t&&t());a&&!a.closed&&s.current.closeWebrtc(a.getRtcId(),!0,!1),s.current.createWebrtcAndSubscribeStream(e,{onGotRemote:function(e){t&&t(e)},onEvent:function(e){n&&n(e)}},void 0,r)},closePubstream:function(e){e.located()&&(u.emedia.stopTracks(e._localMediaStream),u.emedia.stopTracks(e.localStream))},hungup:function(e){var t=this.getStreamById(e);try{this._hungup(e)}finally{this.onHungup&&t&&this.onHungup(t)}},_hungup:function(e){this.__assertCurrent();var t=this.current,n=t._cacheStreams[e];n&&!n.closeReason&&n.updateAttributes({closeReason:"UserHangup"});var r=n&&n.rtcId;if(r&&(t.closeWebrtc(r),n.located()&&(1!==n.type&&n._localMediaStream&&u.emedia.stopTracks(n._localMediaStream),n.remotePlayAudioObject&&document.body.removeChild(n.remotePlayAudioObject),t._cacheStreams[e]&&t.onRemoveStream(n),i.removeAttribute(t._cacheStreams,e),this._streamAutomators&&i.removeAttribute(this._streamAutomators,e))),n&&!n.located()){if(t._linkedStreams[n.id]&&i.removeAttribute(t._linkedStreams,n.id),o.warn("Hangeup remove from _linkedStreams. stream = ",n.id),!(n=t._cacheStreams[e]))return;n.updateAttributes({rtcId:void 0,_webrtc:void 0,mediaStream:void 0});var s=new d(n);t.onUpdateStream(s,new s.Update(s))}},postMsg:function(e){this.__assertCurrent(),this.current.postMessage(e)},postMessage:function(e,t,n,i){var o=t;"string"!=typeof t&&(t=JSON.stringify(t)),this.__assertCurrent();var r,s=this.current,c=s._linkedStreams[e];r=c&&c.owner?c.owner.id:e;t=s.newMessage({op:1003,memId:r,arg:t});s.postMessage(t,(n||i)&&function(e){if(i&&i(e,o),0!=e.result){var c=new a.RemoteControlFail({memId:r,failed:e.result,cause:e.msg,type:"postMessage",postMessage:t});return s.onEvent(c),void(n&&n(c,o))}})},torchRemote:function(e,t,n,i){"function"==typeof t&&(i=n,n=t,t=void 0),void 0!==t&&(t=t?1:0),this.__assertCurrent();var r=this.current,s=r._linkedStreams[e];if(!s||s.located())throw o.error("not exsits or locate, not connect",e),e+" not exsits or locate, not connect";var c=s.torch,d={op2:20,streamId:e,tor:t=void 0===t?s.torch?0:1:t},u=r.newMessage({op:1002,memId:s.owner.id,arg:JSON.stringify(d),_reqOps:[100206]});s.updateAttributes({torch:t}),r.postMessage(u,(function(e){if(0!=e.result){var t=new a.RemoteControlFail({stream:s,failed:e.result,cause:e.msg,type:"torch_control"});return r.onEvent(t),s.updateAttributes({torch:c}),void(i&&i(t,s.torch))}n&&n(s.torch)}))},freezeFrameRemote:function(e,t,n){this.__assertCurrent();var i=this.current,r=i._linkedStreams[e];if(!r||r.located())throw o.error("not exsits or locate, not connect",e),e+" not exsits or locate, not connect";var s=!r.freezeFrame,c={op2:20,streamId:e,frz:s?1:0},d=i.newMessage({op:1002,memId:r.owner.id,arg:JSON.stringify(c),_reqOps:[100204]});r.updateAttributes({freezeFrame:s}),i.postMessage(d,(function(e){if(0!=e.result){var o=new a.RemoteControlFail({stream:r,failed:e.result,cause:e.msg,type:"freeze_control"});return i.onEvent(o),r.updateAttributes({freezeFrame:!r.freezeFrame}),void(n&&n(o,r.freezeFrame))}t&&t(r.freezeFrame)}))},base64Img2Blob:function(e){for(var t=e.split(";base64,"),n=t[0].split(":")[1],i=u.atob(t[1]),o=i.length,r=new Uint8Array(o),s=0;s<o;++s)r[s]=i.charCodeAt(s);return new Blob([r],{type:n})},blob2URL:function(e){return URL.createObjectURL(e)},imagesPngContext2URL:function(e){return this.blob2URL(this.blob2URL(e))},downloadFile:function(e,t,n){var i=document.createElement("a");i.style.display="none";var o,r=t?this.base64Img2Blob(t):n;i.download=e,i.href=o=this.blob2URL(r),i.rel="noopener";var s=document.createEvent("HTMLEvents");s.initEvent("click",!1,!1),i.dispatchEvent(s),document.body.appendChild(i),i.click(),i.parentNode.removeChild(i),setTimeout((function(){URL.revokeObjectURL&&URL.revokeObjectURL(o)}),4e4)},videoCaptureBase64Context2URL:function(e){return this.imagesPngContext2URL(this.getCaptureBase64Context(e))},getCaptureBase64Context:function(e){var t=document.createElement("canvas");t.id="__capture_video_"+(new Date).getTime();return t.width=e.videoWidth,t.height=e.videoHeight,t.getContext("2d").drawImage(e,0,0,t.width,t.height),t.toDataURL("images/png")},captureVideo:function(e,t,n){var i=this.getCaptureBase64Context(e);return t&&(n=n||"capture_"+(new Date).getTime(),this.downloadFile(n,i)),i},capturePictureRemote:function(e,t,n,i){this.__assertCurrent();var r=this.current,s=r._linkedStreams[e];if(!s||s.located())throw o.error("not exsits or locate, not connect",e),e+" not exsits or locate, not connect";var c={op2:20,streamId:e,pic:1,rspBase64Pic:!0===t},d=r.newMessage({op:1002,memId:s.owner.id,arg:JSON.stringify(c),_reqOps:[100205]});r.postMessage(d,(function(e){if(0!=e.result){var o=new a.RemoteControlFail({stream:s,failed:e.result,cause:e.msg,type:"capture_control"});return r.onEvent(o),void(i&&i(o))}if(t)if(e.arg){var c=JSON.parse(e.arg);n&&n(c.pic)}else i&&i(new a.RemoteControlFail({stream:s,failed:e.result,cause:"Not found base64 pic"}));else n&&n()}))},zoomRemote:function(e,t,n,i){this.__assertCurrent();var r=this.current,s=r._linkedStreams[e];if(!s||s.located())throw o.error("not exsits or locate, not connect",e),e+" not exsits or locate, not connect";s._zoom||s.updateAttributes({_zoom:1});var c=s._zoom*t;if(!(c<1)){s.updateAttributes({_zoom:c});var d={op2:20,streamId:e,zoom:Math.round(1e4*c)},u=r.newMessage({op:1002,memId:s.owner.id,arg:JSON.stringify(d),_reqOps:[100201]});r.postMessage(u,(function(e){if(0!=e.result){var t=new a.RemoteControlFail({stream:s,failed:e.result,cause:e.msg,type:"zoom_control"});return r.onEvent(t),void(n&&n(t))}i&&i()}))}},_getPosition:function(e){for(var t=0,n=0;e;)n+=e.offsetLeft,t+=e.offsetTop,e=e.offsetParent;return{clientX:n,clientY:t}},eventXYAtMedia:function(e,t){var n=i.getDomPageRect(t),o=n.width,r=n.height,s=t.videoWidth,a=t.videoHeight;if(a/s>r/o){var c=s/a;s=(a=r)*c}else{c=a/s;a=(s=o)*c}var d,u,l=e;if((d=i.isFloat(l.x))&&(l.x=l.x*o),(u=i.isFloat(l.y))&&(l.y=l.y*r),!(Math.abs(l.x)<(o-s)/2||o-Math.abs(l.x)<(o-s)/2||Math.abs(l.y)<(r-a)/2||r-Math.abs(l.y)<(r-a)/2))return l.x=l.x<0?Math.floor(l.x+(o-s)/2):Math.floor(l.x-(o-s)/2),l.y=l.y<0?Math.floor(l.y+(r-a)/2):Math.floor(l.y-(r-a)/2),d&&(l.x=l.x/s),u&&(l.y=l.y/a),{x:l.x,y:l.y,width:s,height:a}},eventXYAtVideo:function(e,t){var n,o,r=i.getDomPageRect(t),s=r.width,a=r.height,c=t.videoWidth,d=t.videoHeight;if(d/c>a/s){var u=c/d;c=(d=a)*u}else{u=d/c;d=(c=s)*u}return(n=i.isFloat(e.x))&&(e.x=e.x*c),(o=i.isFloat(e.y))&&(e.y=e.y*d),e.x=e.x<0?Math.floor(e.x-(s-c)/2):Math.floor(e.x+(s-c)/2),e.y=e.y<0?Math.floor(e.y-(a-d)/2):Math.floor(e.y+(a-d)/2),n&&(e.x=e.x/s),o&&(e.y=e.y/a),e},getClickXY:function(e,t){var n=t||u.event,i=document.documentElement.scrollLeft||document.body.scrollLeft,r=document.documentElement.scrollTop||document.body.scrollTop,s=n.pageX||n.clientX+i,a=n.pageY||n.clientY+r,c=this._getPosition(e);o.info("Video tag position ",c.clientX,":",c.clientY);var d=e.videoWidth,l=e.videoHeight;if(l/d>e.offsetHeight/e.offsetWidth){var f=d/l;d=(l=e.offsetHeight)*f,c.clientX+=(e.offsetWidth-d)/2}else{f=l/d;l=(d=e.offsetWidth)*f,c.clientY+=(e.offsetHeight-l)/2}return o.info("Media position ",c.clientX,":",c.clientY),o.info("Media xy ",d,":",l),o.info("Click position ",s,":",a),{mediaWidth:d,mediaHeight:l,x:s-c.clientX,y:a-c.clientY}},focusExpoRemote:function(e,t,n,i,r){var s=n||u.event,a=document.documentElement.scrollLeft||document.body.scrollLeft,c=document.documentElement.scrollTop||document.body.scrollTop,d=s.pageX||s.clientX+a,l=s.pageY||s.clientY+c,f=this._getPosition(t);o.info("Video tag position ",f.clientX,":",f.clientY);var m=t.videoWidth,h=t.videoHeight;if(h/m>t.offsetHeight/t.offsetWidth){var p=m/h;m=(h=t.offsetHeight)*p,f.clientX+=(t.offsetWidth-m)/2}else{p=h/m;h=(m=t.offsetWidth)*p,f.clientY+=(t.offsetHeight-h)/2}o.info("Media position ",f.clientX,":",f.clientY),o.info("Media xy ",m,":",h),o.info("Click position ",d,":",l),this._focusExpo(e,m,h,d-f.clientX,l-f.clientY,i,r)},_focusExpo:function(e,t,n,i,r,s,c){if(!(i<=0||i>t||r<=0||r>n)){this.__assertCurrent();var d=this.current,u=d._linkedStreams[e];if(!u||u.located())throw o.error("not exsits or locate, not connect",e),e+" not exsits or locate, not connect";var l={op2:20,streamId:e,focus:1,expo:1,x:0===t?0:Math.round(1e4*i/t),y:0===n?0:Math.round(1e4*r/n)},f=d.newMessage({op:1002,memId:u.owner.id,arg:JSON.stringify(l),_reqOps:[100202,100203]});d.postMessage(f,(function(e){if(0!=e.result){var t=new a.RemoteControlFail({stream:u,failed:e.result,cause:e.msg,type:"focus_expo_control"});return d.onEvent(t),void(s&&s(t))}c&&c()}))}},_republish:function(e,t,n){o.info("Republish stream. it = ",e.id);var i,r,s=this;if(e.id){var a=s.current.__getWebrtcFor(e.id);a&&s.current.closeWebrtc(a,!0),i=s.current._getWebrtc(e.id)}switch(e.type){case 0:u.emedia.stopTracks(e._localMediaStream),r=new s.AVPubstream(e);break;case 1:u.emedia.stopAndRemoveAudioTracks(e._localMediaStream),r=new s.ShareDesktopPubstream(e);break;case 2:u.emedia.stopTracks(e._localMediaStream),r=new s.AudioMixerPubstream(e)}setTimeout((function(){s.openUserMedia(r).then((function(){e.localStream=r.localStream,e.isRepublished=!0,e.optimalVideoCodecs=e.optimalVideoCodecs||i&&i.optimalVideoCodecs,s.push(e,t,n)}),n)}),100)},chanageCamera:function(e,t,n){var r=this;"string"==typeof e?e=r.current._cacheStreams[e]:e.id&&(e=r.current._cacheStreams[e.id]),e.voff?o.warn("Stream id = ",e.id," voff, do not chanage camera."):r.getMediaDevices("videoinput",(function(s){if(s.length<=1)o.warn("Only video input. not chanage");else{var a=e._cameraIndex;if(null===e._cameraIndex||void 0===e._cameraIndex){var c=e.getLocalMediaStream(),d=(h=c&&c.getVideoTracks())&&h.length&&h[0];if(d&&d.getCapabilities&&"function"==typeof d.getCapabilities){var l=d.getCapabilities(),f=l&&l.deviceId;for(var m in s){if((_=s[m]).deviceId===f||_.label==d.label){a=parseInt(m);break}}}else for(var m in s){if((_=s[m]).label==d.label){a=parseInt(m);break}}}for(;a<s.length;){var h,p=s[a],_=s[a=(a+1)%s.length];if(!(h=e.getLocalMediaStream().getVideoTracks())||0===h.length||_.label!=h[0].label)break}var g=(_=s[a]).label;o.warn("Stream ",e.id,p.label,">>",g),e._cameraIndex=a,e.constaints||(e.constaints={});var v=i.extend({},e.constaints);e._lastConstaints=v,e.constaints.video="object"==typeof e.constaints.video?e.constaints.video:{},e.constaints.video.deviceId={exact:_.deviceId},r._republish(e,(function(e){n&&n(e)}),(function(n){n instanceof u.emedia.event.OpenMediaError&&(e.constaints=v),t&&t(n)}))}}),t)},voff:function(e,t,n,i){var r=this;"string"==typeof e&&(e=r.current._cacheStreams[e]);var s=e.voff;function a(){t!=s?(u.emedia.enableVideoTracks(e.getMediaStream(),!t),r.current&&r.current.voff(e,t)):o.info("pubstream voff not chanage.")}if(t=t?1:0,e.voff=t,!t&&e.constaints&&!e.constaints.video){var c=e.constaints.video;return e.constaints.video=!0,void r._republish(e,(function(e){a(),i&&i(e)}),(function(t){t instanceof u.emedia.event.OpenMediaError&&(e.constaints.video=c,e.voff=s),n&&n(t)}))}a(),i&&i(e.getMediaStream())},aoff:function(e,t,n,i){var r=this;"string"==typeof e&&(e=r.current._cacheStreams[e]);var s=e.aoff;function a(){t!=s?(u.emedia.enableAudioTracks(e.getMediaStream(),!t),r.current&&r.current.aoff(e,t)):o.info("pubstream aoff not chanage.")}if(t=t?1:0,e.aoff=t,!t&&e.constaints&&!e.constaints.audio){var c=e.constaints.audio;return e.constaints.audio=!0,void r._republish(e,(function(e){a(),i&&i(e)}),(function(t){t instanceof u.emedia.event.OpenMediaError&&(e.constaints.audio=c,e.aoff=s),n&&n(t)}))}a(),i&&i(e.getMediaStream())},iceing:function(e){return i.isPlainObject(this.current._linkedStreams[e])},recording:function(e){return i.isPlainObject(this.current._records[e])},startRecord:function(e,t){var n=this.current._linkedStreams[e];if(!n)throw o.error("not at linked streams",e),e+" not at linked streams";n._webrtc||t&&t(!1),this.current.startRecord(n,t)},stopRecord:function(e,t){var n=this.current._records[e];if(!n)throw o.error("not at recording streams",e),e+" not at recording streams";this.current.stopRecord(n,t)},getCurrentMembers:function(){return this.current.getCurrentMembers()},_onCapturePicture:function(e){var t,n=e.arg.rspBase64Pic,i=e.arg.streamId,r=this.current._cacheStreams[i];if(n){var s;if("function"!=typeof this.getHTMLVideo||!(s=this.getHTMLVideo(i)))return void o.warn("Not support capture picture. caused by htmlVideo not found");t=this.getCaptureBase64Context(s)}else{if("function"!=typeof this.onCapturePicture)return void o.warn("Not support capture picture. caused by onCapturePicture not found");this.onCapturePicture(r)}var a=this.current.newMessage({op:1001,tsxId:e.tsxId,memId:e.memId,arg:JSON.stringify(t?{pic:t}:{}),result:0});return this.current.postMessage(a,(function(e){o.warn("Send remote control onCapturePicture response. the result = ",e.result,e.msg||"")})),!0},newSession:function(e,t){var n=this;return new(n.Session||r)({ticket:t,owner:e,onReconnect:function(t,n){e.onReconnect(t,n.tkt)},onTcklC:function(t){e.onTcklC(t.rtcId,t.cands)},onAcptC:function(t){e.onAcptC(t.rtcId,t.sdp,t.cands)},onAnsC:function(t){e.onAnsC(t.rtcId,t.sdp,t.cands)},onTermC:function(t){o.info("Server termc rtc: ",t.rtcId,t.message||t.msg),21===t.endReason||22===t.endReason?i.forEach(e._cacheStreams,(function(n,i){var o;i.rtcId===t.rtcId&&(o=21===t.endReason?new u.emedia.event.SwitchVCodes({stream:i,useVCodes:t.useVCodes}):new u.emedia.event.SubFailNotSupportVCodes({stream:i}),e.onEvent(o))})):e.closeWebrtc(t.rtcId,!1,!0)},onEnter:function(t){e.onEnter(t.cver,t.mem)},onExit:function(t){e.onExit(t.cver,t.memId,t.reason||0)},onPub:function(t){e.onPub(t.cver,t.memId,t.pubS)},onUnpub:function(t){e.onUnpub(t.cver,t.memId,t.pubSId)},onMems:function(e){},onClose:function(t){e.onClose(t.cver,t.confrId)},onEvent:function(t){e.onEvent(t)},onStreamControl:function(t){e.onStreamControl(t.cver,t.streamId,t.voff,t.aoff,t.sver)},onRoleUpdate:function(t){e._onRoleUpdate(t.role,t.roleToken)},onRemoteControl:function(t){if("string"==typeof t.arg&&(t.arg=JSON.parse(t.arg)),20!==t.arg.op2||!t.arg.pic||!n._onCapturePicture.call(n,t)){if(30===t.arg.op2&&n._onRemotePannelControl)try{return void n._onRemotePannelControl.call(n,t)}catch(e){o.warn(e)}o.warn("Not support remote control");var i=e.newMessage({op:1001,tsxId:t.tsxId,memId:t.memId,arg:JSON.stringify(t.arg),result:t&&t.arg&&30===t.arg.op2?-405:-507,msg:"Not support the remote control."});e.postMessage(i,(function(e){o.warn("Send remote control response. the result = ",e.result,e.msg||"")}))}},onRecvRemoteMessage:function(t){e._onRecvRemoteMessage&&e._onRecvRemoteMessage(t.memId,t.arg,t)},onConfrAttrsUpdated:t=>{let n=e.catrrs;n||(n=[]),n=t.cattrs instanceof Array==1?function(e,t){return 0==t.length?e:(t.forEach(t=>{let n=!1;e.forEach((i,o)=>{if(i.key==t.key)return e.splice(o,1,t),void(n=!0)}),n||e.push(t)}),e)}(n,t.cattrs):function(e){let t=[];for(let n in e){let i={};i.key=n,i.val=e[n],i.op="",t.push(i)}return t}(t.cattrs),e.catrrs=n;let i=e._onConfrAttrsUpdated;i&&"function"==typeof i&&i(n)}})},_judgeTalking:function(e){return!!e&&e.instant>=u.emedia.config.judgeTalkingByInstantGE},graffitiVideo:function(e,t,n){var i=this.getStreamById(e),o=new MediaStream;o._located=!0,i._localMediaStream.getAudioTracks().forEach((function(e){o.addTrack(e)})),n.captureStream(25).getVideoTracks().forEach((function(e){o.addTrack(e)})),t.srcObject=o,i.updateAttributes({localStream:o,isRepublished:!0,optimalVideoCodecs:i.optimalVideoCodecs}),this.push(i)},resetCanvas:function(e){var t;if(arguments.length>1)for(var n=0;n<arguments.length;n++)"function"==typeof(t=arguments[n])&&t(e),"function"!=typeof t&&i.isPlainObject(t)&&i.forEach(t,(function(t,n){o.debug("Canvas set ",t," = ",n),e.setAttribute(t,n)}))},_random:function(e){return Math.floor(Math.random()*e)},requestFrame:function(e,t){var n,i=this;if("string"==typeof e)n=this.current._cacheStreams[e];else{if(!e.id)return;n=this.current._cacheStreams[e.id]}function o(){n.requestFrame()}n&&(t?setTimeout((function(){o(),i.requestFrame(n,t)}),t):o())},graffitiCanvas:function(e,t){i.targetDOM(e)&&(t=e,e=!1);var n=this,o=new n.ShareDesktopPubstream({voff:0,aoff:e?0:1});t||(t=document.createElement("canvas")),t.getContext("2d"),o.canvas=t;var r=function(){};return r.prototype.setCanvas=function(e){return this.canvasTag=t,n.resetCanvas(t,e),this},r.prototype.push=function(e,t){this._push(e,t)},r.prototype._push=function(i,r){"function"==typeof i&&(r=i,i=void 0),t.captureStream&&(t.captureStream.enabled=!0);var s=t.captureStream(i||25);function a(n){n.canvas=t,r&&r(n,t,s),e&&n.requestFrame()}function c(e,t){var i=new MediaStream;i._located=!0,e._localMediaStream&&e._localMediaStream.getAudioTracks().forEach((function(e){i.addTrack(e)})),s.getVideoTracks().forEach((function(e){i.addTrack(e)})),e._localMediaStream=i,e.localStream=i,n.push(e,t)}return e?n.__getUserMedia({audio:!0},(function(e,t){o._localMediaStream=t,c(o,a)})):c(o,a),this},new r},blobRecorder:function(e,t,n,r){var s=this;i.targetDOM(e)&&(e=e.srcObject),t||(t={mimeType:"video/webm;codecs=vp9"}),MediaRecorder.isTypeSupported(t.mimeType)||(o.info(t.mimeType," is not Supported"),t={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(t.mimeType)||(o.info(t.mimeType," is not Supported"),t={mimeType:"video/webm"},MediaRecorder.isTypeSupported(t.mimeType)||(o.info(t.mimeType," is not Supported"),t={mimeType:""})));try{var a=new MediaRecorder(e,t)}catch(e){return void o.error("Exception while creating MediaRecorder: ",e)}var c=[];function d(){this.blobs=c}return a.onstop=r||function(e){o.info("Recorder stopped: ",e)},a.ondataavailable=n||function(e){e.data&&e.data.size>0&&c.push(e.data)},d.prototype.start=function(e){a.start(e)},d.prototype.stop=function(){a.stop()},d.prototype.playurl=function(e){var t=new Blob(this.blobs,e||{type:"video/webm"});return u.URL.createObjectURL(t)},d.prototype.download=function(e,t){var n=new Blob(this.blobs,t||{type:"video/webm"});s.downloadFile(e,void 0,n)},new d}})},function(e,t,n){var i=n(0),o=i.tagLogger("Sess"),r=n(1),s=n(2),a=0,c=i.getEnvInfo().global,d=i.prototypeExtend({setSessId:function(e){return e&&(this.sessId=e),this},setOp:function(e){if(e&&(this.op=e),200===e){var t=c.emedia.config.useUniappPlugin;this.res={type:t?"UNIAPP":"MINI_PROGRAM",ver:"3.2.2",platVersion:c._emediaVersion||c.emedia.config.version,agent:"v2.7.0",ops:c.emedia.config.acptOps}}return this},setTsxId:function(e){return e&&(this.tsxId=e),this},setTicket:function(e){return e&&(this.tkt=e),this},setSdp:function(e){return e&&(this.sdp=e),this},setCands:function(e){return e&&(this.cands=e),this},setSubSId:function(e){return e&&(this.subSId=e),this},setMemId:function(e){return e&&(this.memId=e),this},setPubS:function(e){e&&(this.pubS=i.extend(!1,{},e));var t=this.pubS;return t.ext&&i.isPlainObject(t.ext)&&(t.ext=JSON.stringify(t.ext)),t&&i.forEach(t,(function(e,n){(i.isPlainObject(n)||"function"==typeof n)&&i.removeAttribute(t,e)})),t&&i.removeAttribute(t,"localStream"),t&&i.removeAttribute(t,"_localMediaStream"),t&&i.removeAttribute(t,"_webrtc"),this},setRtcId:function(e){return e&&(this.rtcId=e),this},setCver:function(e){return e&&(this.cver=e),this},setEndReason:function(e){return e&&(this.endReason=e),this},setNickName:function(e){return e&&(this.nickName=e),this},setResource:function(e){return e&&(this.resource=e),this},setReason:function(e){return e&&(this.reason=e),this},setConfrId:function(e){return e&&(this.confrId=e),this},setVoff:function(e){return void 0===e||(this.voff=e?1:0),this},setAoff:function(e){return void 0===e||(this.aoff=e?1:0),this},setFlag:function(e){return 0===e&&(this.flag=0),1===e&&(this.flag=1),this},setExt:function(e){return e&&i.isPlainObject(e)&&(e=JSON.stringify(e)),e&&(this.ext=e),this}}),u=c.emedia.__session_globalCount=0;function l(e,t,n){var s=this;function a(e,i){try{s.onWebsocketEvent(new r.WSClose({url:s.thisWsUri,retry:n,online:s.online,cause:e,event:i,session:s}))}finally{t&&t(new r.WSClose({url:s.thisWsUri,retry:n,online:s.online,cause:e,event:i,session:s}))}}function d(e){if(s.connected(s.thisWsUri))if(s.sessId&&e.sessId!=s.sessId)o.warn("self.sessId && message.sessId != self.sessId",e);else{var t=JSON.stringify(e);console.log("sdk 发送信令成功",e),s._websocket.send({data:t})}else o.debug("current dont connect. the message = ",e)}s.notifyNewMessage=function(){if(s.connected(s.thisWsUri)){if(0===s._bufferedMessages.length)return;for(var e,t=[];e=s._bufferedMessages.shift();)if(e.sessId||s.sessId||200==e.op){if(200===e.op){d(e);break}s.sessId&&!e.sessId&&(e.sessId=s.sessId);var r=d(e);r&&t.push(r)}else t.push(e),o.warn("tmp store message, util enter success!",e);t.length>0&&Array.prototype.push.apply(s._bufferedMessages,t)}else if(0!==n&&s.online)s.connected();else{var a=i.extend(!1,{},s._callbacks),c=[];for(var u in a){var l=a[u];n>0&&!s.online?c.push(l):s.onMessage({op:1001,tsxId:u,result:-9527,msg:"sdk rsp fail. retry fail or online = "+s.online})}s._bufferedMessages=s._bufferedMessages||[],c.length>0&&Array.prototype.push.apply(s._bufferedMessages,c)}},o.info("Session begin connect.");var u=s._websocket;u&&(o.warn("will close. websocket state",u.readyState,u.url,s.thisWsUri),u.close({code:1e3}));try{o.info("Connecting",s.thisWsUri,n),u=s._websocket=c.connectSocket({url:s.thisWsUri,success:function(){},fail:function(e){}})}catch(e){return o.warn(e),void a(e)}u.onOpen((function(n){var i=this.url;try{o.info("websocket connected:",i),t&&(t=null),e&&e(s)}finally{}})),u.onMessage((function(e){o.debug("recv data",e.data);var t=JSON.parse(e.data);t&&1001==t.op&&o.debug("recv message: rsp:",t),t&&1001!=t.op&&o.debug("recv message: evt:",t),s.onMessage(t)})),u.onClose((function(e){var t=this.url;o.info("Disconnected:",t,s.thisWsUri,e),t===s.thisWsUri?(s.notifyNewMessage(),1e3!==e.code&&a(void 0,e)):o.warn("ignore onclose. caused by websocket url not ",s.thisWsUri,t)})),u.onError((function(e){o.info("On error:",e),a&&a(e),s.onWebsocketEvent(new r.WSError({event:e,online:s.online,session:s,url:this.url}))}))}e.exports=i.prototypeExtend({_events:{0:"onReqP2P",1:"onNewCfr",2:"onDelCfr",3:"onReqTkt",100:"onPing",101:"onPong",102:"onInitC",104:"onAcptC",105:"onTcklC",106:"onAnsC",107:"onTermC",300:"onEnter",301:"onExit",302:"onPub",303:"onUnpub",304:"onMems",204:"onClose",400:"onStreamControl",401:"onJoin",412:"onRoleUpdate",1002:"onRemoteControl",1003:"onRecvRemoteMessage",402:"onConfrAttrsUpdated"},__init__:function(){var e=this;e._bufferedMessages=[],e._callbacks={},e.online=!0,c.onNetworkStatusChange((function(t){t.isConnected?(e.online=!0,o.warn("online online online"),e.closed||e._reconnect(c.emedia.config.reconnect)):(e.online=!1,o.warn("offline offline offline"),e.__checkConnectIntervalId&&clearTimeout(e.__checkConnectIntervalId),e.__retryConnectIntervalId&&clearTimeout(e.__retryConnectIntervalId),e.__retryConnectIntervalId&&delete e.__retryConnectIntervalId,e._websocket&&e._websocket.close(1e3))})),o.info("online status = ",e.online)},_nextWsUri:function(){var e=this.ticket.url||"";if("function"==typeof c.emedia.convertWebsocketURLOfTicket){var t=e;e=c.emedia.convertWebsocketURLOfTicket(e),o.warn(t,"--\x3e",e)}return e.indexOf("?")>=0?e+="&"+a++:e+="?"+a++,this.ticket.confrId&&(e+="&"+encodeURIComponent(this.ticket.confrId)),e},_reconnect:function(e){var t=this;function n(){o.warn("Reconnected. at ",e,t._websocket.url),t.__retryConnectIntervalId&&clearTimeout(t.__retryConnectIntervalId),t.__retryConnectIntervalId&&delete t.__retryConnectIntervalId;var n=t.newMessage().setOp(200).setSessId(t._sessionId).setTicket(t.ticket).setNickName(t.nickName||t.ticket.memName).setResource(t.resource).setExt(t.owner.ext);t.postMessage(n,(function(e){if(0==e.result)t.onEvent(new r.EnterSuccess({ip:t.owner.ip})),console.log("Session _reconnect");else try{t.onEvent(new r.EnterFail({me:t.owner,cause:new r.RspFail({request:n,response:e})}))}finally{-9527!==e.result&&t.onEvent(new r.ServerRefuseEnter({failed:e.result,msg:e.msg}))}}))}t.connect(n,(function i(r){if(e<=0)return o.warn("Reconnect end. but fail.",r.url,e),void(t.__retryConnectIntervalId&&delete t.__retryConnectIntervalId);e&&(t.__retryConnectIntervalId=setTimeout((function(){t.connect(n,i,--e)}),c.emedia.config.reconnectDelay))}),--e)},__checkConnect:function(){var e=this;e.__checkConnectIntervalId&&clearTimeout(e.__checkConnectIntervalId),c.emedia.config.checkConnectIntervalMillis&&(e.__checkConnectIntervalId=setTimeout((function(){try{e.online&&!e.connected()&&(e.__retryConnectIntervalId&&o.debug("online, reconnecting..."),e.__retryConnectIntervalId||o.debug("online, but disconnect. will reconnect"),e.__retryConnectIntervalId||e._reconnect(c.emedia.config.reconnect))}finally{e.__checkConnect()}}),c.emedia.config.checkConnectIntervalMillis))},connect:function(e,t,n){var i=this,s=i.thisWsUri=i._nextWsUri();void 0!==n&&o.warn("begin connect... at retry = ",n,s),l.call(i,(function(){try{e.apply(i,arguments)}finally{i.__checkConnect()}}),(function(e){try{t.apply(i,arguments)}finally{n||e.url!==s||i.onEvent(new r.ServerRefuseEnter({failed:-95270,msg:"sdk reconnect fail. "+s+"|"+e.url}))}}),n)},connected:function(e){return this.online&&this._websocket},onWebsocketEvent:function(e){this.onEvent(e)},register:function(e){if("object"==typeof e)for(var t in e)this.bind(t,e[t])},bind:function(e,t){var n;if(!(n=this._events[e]))throw o.error("Not supported event = ",e),"Not supported event = "+e;this[n]=t},getSessionId:function(){return this._sessionId},newMessage:function(e){return new d(e)},__modifyMessage:function(e){return e},onMessage:function(e){var t=this;function n(e){var n,i=e.op;(n=t._events[i])&&(n=t[n])?n.call(t,e):o.warn("Not supported event = ",e)}if(console.log("servMessage.op",e.op),console.log("servMessage",e),102!==e.op&&104!==e.op&&105!==e.op&&106!==e.op&&107!==e.op||s.onSignallingData(e),1001===e.op&&e.useUrl||1001===e.op&&e.rtcCfg){this.useUrl=e.useUrl;t.sessId=e.sessId;var a=t.ticket.memName;s._videos.useUrl=e.useUrl;var c={role:e.role,memName:a,name:a,nickName:a,vcodes:e.vcodes,rtcCfg:e.rtcCfg,id:e.memId,isSelf:!0,sessId:e.sessId};t.onEnter.call(t,{mem:c})}if(1001!=e.op&&!e.sessId)throw o.error("message sessId error. server evt data error"),"message sessId error. server evt data error";if(1001!=e.op&&t._sessionId&&t._sessionId!=e.sessId)throw o.error("message sessId error. server and local not equal"),"message sessId error. server and local not equal";if(1004!==e.op){var d;e=t.__modifyMessage(e);var u=i.removeAttribute(t._callbacks,e.tsxId);if(u&&200===u.op){t._sessionId=e.sessId;var l="string"==typeof e.yourIp?e.yourIp:void 0;if("string"==typeof t._session_ip&&l!=t._session_ip&&(d=t._session_ip),o.info(t._sessionId,"ip is",l,d),t._session_ip=l,t.owner.ip=l,0===e.result){for(var f in t._bufferedMessages){var m=t._bufferedMessages[f];m.sessId||200===m.op||(m.sessId=e.sessId)}setTimeout((function(){t.notifyNewMessage()}),100)}else for(var h;h=t._bufferedMessages.shift();)200!==h.op&&t.onMessage({op:1001,tsxId:h.tsxId,result:-9527,msg:"sdk enter fail. sdk callback. enter result = "+e.result})}if(t.owner&&t.owner.closed)o.warn("self closed. me is "+t.owner.getMemberId()+", session_id = "+t.getSessionId()+". drop message",e);else{if(t.onEvent(new r.RecvResponse({request:u,response:e})),u&&u.__callback__&&1004!==e.op)return u.__callback__(e),void(d&&t.onWebsocketEvent(new r.NetworkChanaged({preIp:d,nowIp:t._session_ip})));e.op&&1001!=e.op?(n(e),d&&t.onWebsocketEvent(new r.NetworkChanaged({preIp:d,nowIp:t._session_ip}))):o.debug("Igron message. caused by op not found.",e)}}else n(e)},__modifyMessageForPost:function(e){return e},postMessage:function(e,t,n){var r=this;if(e.tsxId||(e.tsxId="MSG"+Date.now()+"-"+u++),e.memId){var s=r.owner._cacheMembers[e.memId];if(!s)return o.warn("Member not found at local. memberId = "+e.memId,e),void(t&&t({op:1001,tsxId:e.tsxId,result:-507,msg:" member not found at local. memberId = "+e.memId}));var a=e._reqOps;for(var d in a||(a=[]).push(e.op),a){var l=a[d];if(!s.acptOps[l])return o.warn("Member not accept op "+l+", "+e.memId,e),void(t&&t({op:1001,tsxId:e.tsxId,result:-507,msg:" member not accept op "+l+", "+e.memId}))}}if(i.removeAttribute(e,"_reqOps"),r._sessionId&&r._sessionId!=e.sessId)return o.warn("sessionId not excepted. self._sessionId = "+r._sessionId,e),void(t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"sessionId not excepted."}));if(r.closed)return o.warn("session closed.",e),void(t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"session closed"}));var f=i.extend({},e);if(!(e=r.__modifyMessageForPost(e)))return o.warn("Message drop. callback success.",e),void(t&&t({op:1001,tsxId:f.tsxId,result:0,msg:"Message drop. callback success."}));200===e.op?(r._bufferedMessages.unshift(e),t&&setTimeout((function(){r._callbacks[e.tsxId]&&(o.error("Enter timeout. fail."),r.onMessage({op:1001,tsxId:e.tsxId,result:-9527,msg:"enter timeout. millis = "+c.emedia.config.enterTimeout}))}),c.emedia.config.enterTimeout||2e3)):r._bufferedMessages.push(e),t&&(r._callbacks[e.tsxId]=i.extend(e,{__callback__:t.bind(r.owner)})),r.notifyNewMessage&&r.notifyNewMessage(),n&&t&&setTimeout((function(){var e=r._callbacks[e.tsxId];e&&e.__callback__&&e.__callback__({op:1001,tsxId:f.tsxId,result:-408,msg:"Message request timeout."}),i.removeAttribute(r._callbacks,e.tsxId)}),n)},close:function(e){o.warn("sessiong closing, reason = ",e);this.notifyNewMessage&&this.notifyNewMessage(),this.closed=!0,this.seqno=0,this._websocket&&(0==e||100==e?this._websocket.close(1e3):this._websocket.close()),this.__retryConnectIntervalId&&clearTimeout(this.__retryConnectIntervalId),this.__retryConnectIntervalId&&delete this.__retryConnectIntervalId,this.__checkConnectIntervalId&&clearTimeout(this.__checkConnectIntervalId),this.__checkConnectIntervalId&&delete this.__checkConnectIntervalId,this.owner=null,this._bufferedMessages=[],this._callbacks={},o.warn("session closed")}})},function(e,t,n){var i=n(0),o=i.tagLogger("Me"),r=n(9),s=n(1),a=n(4),c=n(2),d=i.getEnvInfo().global,u=r.extend({__init__:function(){if(this._session||this.sessionFactory&&(this._session=this.sessionFactory()),!this._session)throw o.error("Require session"),"Require session";this._cver=0,this._cacheMembers={},this._cacheStreams={},this._streamAutomators={},this._mediaMeters={},this._openedRtcMediaStreams={},this._linkedStreams={},this._maybeNotExistStreams={},this._records={},this._ices={},this.audioMixers={},this.closed=!1,this._nextStreamSeqno=0,this.cattrs=c.cattrs,this.getMediaMeterIntervalMillis=this.getMediaMeterIntervalMillis||d.emedia.config.getMediaMeterIntervalMillis},getCurrentMembers:function(){var e=[];return i.forEach(this._cacheMembers,(function(t,n){var o=i.extend(!0,{},n);e.push(o)})),e},newStream:function(e){var t=this;return new a(e,{__init__:function(){if(this.rtcId||this._webrtc&&(this.rtcId=this._webrtc.getRtcId()),this._webrtc||this.rtcId&&(this._webrtc=t._ices[this.rtcId]),this.__create_id=t._nextStreamSeqno++,this.memId&&!this.owner&&(this.owner=i.extend({},t._cacheMembers[this.memId]),!this.owner&&!this.located()))throw o.error("Remote stream, not owner. it = ",this.id),"Remote stream, not owner. it = "+this.id}})},getConfrId:function(){return this.ticket.confrId},isCaller:function(){return this.isP2P()&&this.ticket.caller==this.ticket.memName},isCallee:function(){return this.isP2P()&&this.ticket.callee==this.ticket.memName},isP2P:function(){return this.ticket&&("P2P"==this.ticket.type||"p2p"==this.ticket.type)},isConfr:function(){return this.ticket&&("CONFR"==this.ticket.type||"confr"==this.ticket.type)},onEvent:function(e){},join:function(e,t){var n=this;d.emedia.requireTrustBeforeJoin()?n.someBrowsersRequireGetUserMedia((function(){n._join(e,t)}),t):n._join(e,t)},_join:function(e,t){o.debug("begin join ...");var n,i=this;if(i._memberId)return o.warn("Had joined. igrone it"),void(e&&e(i.memId));function r(e){try{if(e instanceof s.WSClose&&e.retry)return;e instanceof s.EnterFail||(e=new s.EnterFail({attendee:i,cause:e})),i.onEvent(e),t&&t(e)}finally{}}function a(t){if(0==t.result){i.reflushSupportVCodes(t.vcodes),i.setMemberId(t.memId),i.role=t.role,i.onEvent(new s.EnterSuccess({ip:i.ip})),e&&e(t.memId);try{i.__rtc_cfg=t.rtcCfg,"string"==typeof t.rtcCfg&&(i.__rtc_cfg=JSON.parse(t.rtcCfg))}finally{i.onMembers(t.cver,t.mems),i.onStreams(t.cver,t.streams)}}else try{r(new s.RspFail({request:n,response:t}))}finally{-9527!==t.result&&i.onEvent(new s.ServerRefuseEnter({failed:t.result,msg:t.msg}))}}i.connect((function(){console.log("Attendee","onConnected setOp: 200"),n=i.newMessage().setOp(200).setTicket(i.ticket).setNickName(i.nickName||i.ticket.memName).setResource(i.resource).setExt(i.ext),i.postMessage(n,a)}),r),o.debug("join",i.ticket.url)},withpublish:function(e){var t,n=this;if(!e||!e.localStream)throw o.error("pubS null or stream not open"),"pubS null or stream not open";var i,r=e&&e.localStream;return{join:function(a,c){if(1===arguments.length&&(c=a,a=void 0),n._memberId)return o.warn("Had joined. igrone it"),void(a&&a(n.memId));function u(e){try{if(e instanceof s.WSClose&&e.retry)return;e instanceof s.EnterFail||(e=new s.EnterFail({attendee:n,cause:e})),n.onEvent(e),c&&c(e)}finally{d.emedia.stopTracks(r),i&&n.closeWebrtc(i.getRtcId())}}var l=n.getOptimalVideoCodecs();function f(r){if(0==r.result){n.reflushSupportVCodes(r.vcodes),n.setMemberId(r.memId),n.role=r.role,n.onEvent(new s.EnterSuccess({ip:n.ip}));var c=n.newStream(e);c.updateAttributes({_localMediaStream:e.localStream,rtcId:i.getRtcId(),_webrtc:i,id:r.streamId,csrc:r.csrc,owner:{id:r.memId,nickName:n.nickName,name:n.sysUserId,ext:n.extObj},optimalVideoCodecs:l}),a&&a(r.memId,c),i.useIp=n.ip,n.onEvent(new s.PushSuccess({stream:c,hidden:!0})),r.sdp&&n.ansC(i.getRtcId(),r.sdp),r.cands&&n.tcklC(i.getRtcId(),r.cands);try{n.__rtc_cfg=r.rtcCfg,"string"==typeof r.rtcCfg&&(n.__rtc_cfg=JSON.parse(r.rtcCfg)),n.__rtc_cfg&&n.__rtc_cfg.iceServers&&n.__rtc_cfg.iceServers.length>0&&(o.warn("Server rsp one rtc cfg. publish will republish"),n._service&&setTimeout((function(){n._service._republish(c)}),200))}finally{n.onMembers(r.cver,r.mems),n.onStreams(r.cver,r.streams)}}else try{u(new s.RspFail({request:t,response:r}))}finally{-9527!==r.result&&n.onEvent(new s.ServerRefuseEnter({failed:r.result,msg:r.msg}))}}n.connect((function(){o.debug("enter and pubs");var r,s,a=e.localStream;2===e.type&&(r={offerToReceiveAudio:!0,offerToReceiveVideo:!1},s={subSVideo:!1,subSAudio:!0}),i=n.createWebrtc({_rtcId:e.rtcId,optimalVideoCodecs:l,offerOptions:r,subArgs:s,vbitrate:e.vbitrate||e.constaints&&e.constaints.video&&e.constaints.video.bitrate,abitrate:e.abitrate||e.constaints&&e.constaints.audio&&e.constaints.audio.bitrate},e.iceRebuildCount),n.setLocalStream(a,i.getRtcId()),n.doOffer(i.getRtcId(),(function(o){t=n.newMessage().setOp(200).setTicket(n.ticket).setNickName(n.nickName||n.ticket.memName).setResource(n.resource).setSdp(o).setRtcId(i.getRtcId()).setPubS(e).setExt(n.ext),n.postMessage(t,f)}))}),u),o.debug("join",n.ticket.url)}}},push:function(e,t,n,i){o.debug("begin push ...");var r,a=this;if(2===arguments.length&&(n=t,t=void 0),!e||!e.localStream)throw o.error("pubS or stream open"),"pubS or stream open";var c,u=e.localStream;function l(t){try{var o=a.newStream(e);o.updateAttributes({_localMediaStream:e.localStream,_webrtc:c,rtcId:c&&c.getRtcId(),owner:{id:a.getMemberId(),nickName:a.nickName,name:a.sysUserId,ext:a.extObj}});t=new s.PushFail({stream:o,cause:t,hidden:i&&!0===t.hidden});a.onEvent(t),t.hidden||n&&n(t)}finally{u&&!0!==t.hidden&&d.emedia.stopTracks(u),c&&a.closeWebrtc(c.getRtcId(),!0===t.hidden)}}if(e.rtcId||2!==e.type||d.emedia.config.allowRepeatAudioMixerPublish||!a._service.hasAudioMixers()){var f=e.optimalVideoCodecs||a.getOptimalVideoCodecs();h(e),o.debug("push",a.ticket.url)}else l(new s.AudioMixerStreamRepeatPublish);function m(n,i){if(0==i.result){var o=a.newStream(e);o.updateAttributes({_localMediaStream:e.localStream,_webrtc:n,rtcId:n.getRtcId(),id:i.streamId,csrc:i.csrc,owner:{id:a.getMemberId(),nickName:a.nickName,name:a.sysUserId,ext:a.extObj},optimalVideoCodecs:f}),o.id&&2===o.type&&(a.audioMixers[o.id]=o);try{a.onEvent(new s.PushSuccess({stream:o,hidden:!0}))}finally{i.sdp&&a.ansC(n.getRtcId(),i.sdp),i.cands&&a.tcklC(n.getRtcId(),i.cands),t&&t(o)}}else l(new s.RspFail({request:r,response:i,hidden:!0===i.retrying}))}function h(e){o.debug("pubs");var t,n,i=e.localStream;2===e.type&&(t={offerToReceiveAudio:!0,offerToReceiveVideo:!1},n={subSVideo:!1,subSAudio:!0}),c=a.createWebrtc({_rtcId:e.rtcId,optimalVideoCodecs:f,offerOptions:t,subArgs:n,vbitrate:e.vbitrate||e.constaints&&e.constaints.video&&e.constaints.video.bitrate,abitrate:e.abitrate||e.constaints&&e.constaints.audio&&e.constaints.audio.bitrate},e.iceRebuildCount),a.setLocalStream(i,c.getRtcId()),a.doOffer(c.getRtcId(),(function(t){r=a.newMessage().setOp(102).setRtcId(c.getRtcId()).setSdp(t).setPubS(e),a.postMessage(r,(function(e){m(c,e)}))}))}},isSafari:function(){return d.emedia.isSafari},someBrowsersRequireGetUserMedia:function(e,t){var n=this;if(d.emedia.youInSomeBrowsers()&&!d.emedia._yetGetUserMedia){if(!0===n.__tryingOpenMedia)n.__tryingOpenMediaWaitSuceess=n.__tryingOpenMediaWaitSuceess||[],n.__tryingOpenMediaWaitFail=n.__tryingOpenMediaWaitFail||[],"function"==typeof e&&n.__tryingOpenMediaWaitSuceess.push(e),"function"==typeof t&&n.__tryingOpenMediaWaitFail.push(t);else{function r(t,o){d.emedia._yetGetUserMedia=!0,d.emedia.stopTracks(o),setTimeout((function(){n.__tryingOpenMedia=!1,e&&e.apply(n),n.__tryingOpenMediaWaitSuceess&&i.forEach(n.__tryingOpenMediaWaitSuceess,(function(e,t){t.apply(n)})),n.__tryingOpenMediaWaitSuceess=[],n.__tryingOpenMediaWaitFail=[]}),300)}function s(e){n.__tryingOpenMedia=!1,o.error("Some browsers must getUserMedia, gather cands. now try get audio. fail. subfail"),t&&t.call(n,e),n.__tryingOpenMediaWaitFail&&i.forEach(n.__tryingOpenMediaWaitFail,(function(t,i){i.call(n,e)})),n.__tryingOpenMediaWaitSuceess=[],n.__tryingOpenMediaWaitFail=[]}n.__tryingOpenMedia=!0,n._service.__getUserMedia({audio:!0},r,(function(e){n._service.__getUserMedia({video:!0},r,s)}))}return!0}return!1},createWebrtcAndSubscribeStream:function(e,t,n,r){var a=this;t||(t={});var c=a._cacheStreams[e],u=a._cacheMembers[c.memId],l=c;function f(n){o.warn("sub stream error",e,n),v&&l._webrtc&&l._webrtc.setSubArgs(v),v&&l.updateAttributes({subArgs:v}),n=new s.SubFail({stream:l,hidden:!0===n.hidden,cause:n}),t&&t.onEvent&&t.onEvent(n),a.onEvent&&a.onEvent(n)}function m(){l.updateAttributes(l.subArgs)}r=r||l.subArgs||{subSVideo:!0,subSAudio:2!==c.type};var h=c.vcodes||[],p=u&&u.vcodes||[],_=a.supportVCodes,g=a._getOptimalVideoCodecsSubset(h,p,_);r=r||l.subArgs;var v=l.subArgs,b=!(l.vcodes&&l.vcodes.length>0);d.emedia.isSafari&&(b=b||!!l.voff);var S={offerToReceiveAudio:!0,offerToReceiveVideo:r.subSVideo&&!b};function I(){var s=a.createWebrtc({iceServerConfig:n,optimalVideoCodecs:g,offerOptions:S,onGotMediaStream:function(e){t.onGotRemote&&t.onGotRemote(l)}},l.iceRebuildCount),c=s.getRtcId();o.warn(c," sub stream ",e,g),l.updateAttributes({_webrtc:s,rtcId:c,owner:i.extend({},u)}),r&&l._webrtc&&l._webrtc.setSubArgs(r),r&&l.updateAttributes({subArgs:r})}S.offerToReceiveAudio||S.offerToReceiveVideo||o.warn("offerToReceiveAudio == false and offerToReceiveVideo == false"),a.someBrowsersRequireGetUserMedia((function(){I(),a.offerCall(l.rtcId,null,e,f,m)}),(function(t){o.error("Some browsers must getUserMedia, gather cands. now try get audio. fail. subfail",e),f(t)}))||(I(),a.offerCall(l.rtcId,null,e,f,m))},_getOptimalVideoCodecsSubset:function(e,t,n){var o=this,r=[];if(e&&e.length>0&&n[e[0]]&&r.push(e[0]),0==r.length)for(var s=0;s<o._orderVCodes.length;s++)i.forEach(t,(function(e,t){t==o._orderVCodes[s]&&r.push(t)}));return r},subscribeStream:function(e,t,n,o,r){var a=this,c=a._ices[e],d=a._cacheStreams[t],u=a._cacheMembers[d.memId],l=d;l.updateAttributes({_webrtc:c,rtcId:e,owner:i.extend({},u)});var f=l.subArgs;if(o=o||{subSVideo:!0,subSAudio:!0},l.updateAttributes({subArgs:l.subArgs||{subSVideo:!0,subSAudio:!0}}),l._webrtc&&l._webrtc.setSubArgs(l._webrtc.subArgs||{subSVideo:!0,subSAudio:!0}),!l.subArgs.subSVideo&&o.subSVideo&&!l.voff){var m=d.vcodes,h=u.vcodes,p=a.supportVCodes;a._getOptimalVideoCodecsSubset(m,h,p)}o&&l._webrtc&&l._webrtc.setSubArgs(o),o&&l.updateAttributes({subArgs:o});var _=a.newMessage().setOp(205).setRtcId(e).setSubSId(t);o&&i.extend(_,o),a.postMessage(_,(function(e){if(0!=e.result){f&&l._webrtc&&l._webrtc.setSubArgs(f),f&&l.updateAttributes({subArgs:f});var t=new s.SubFail({stream:l,cause:new s.RspFail({request:_,response:e})});return n&&n(t),void a.onEvent(t)}l.updateAttributes(l.subArgs);t=new s.SubSuccess({stream:l,hidden:!0});a._updateRemoteStream(l,l._webrtc.getRemoteStream()),a.onEvent(t),"function"==typeof r&&r()}))},unsubscribeStream:function(e){var t=this._cacheStreams[e],n=t._webrtc&&t._webrtc.getRtcId();if(n){try{var i=this.newMessage().setOp(206).setRtcId(n).setSubSId(e);this.postMessage(i)}finally{this.closeWebrtc(n)}return n}},onReconnect:function(e,t){console.log("onReconnect");let n=t.confrId,i=JSON.stringify(t);c.exitConference(n),setTimeout(()=>{c.joinConferenceWithTicket(n,i).then((function(e){c.onReconnect(e,t)}))},100)},onSignallingData:function(e){c.onSignallingData(e)},onEnter:function(e,t){var n=this;if(e&&(n._cver=e),t&&!n._cacheMembers[t.id]){n._cacheMembers[t.id]=t;var o={};t.res&&t.res.vcodes&&t.res.vcodes.length>0&&i.forEach(t.res.vcodes,(function(e,t){o[t]||(o[t]=!0,n.supportVCodes[t]&&n.supportVCodes[t]++)})),n.onAddMember(i.extend({},t))}},_onFinally:function(){this._cacheMembers={},this._cacheStreams={},this._linkedStreams={},this._ices={},this._maybeNotExistStreams={};var e=[];if(i.forEach(this._openedRtcMediaStreams,(function(t,n){!1!==n.active&&e.push(n)})),e.length>0)for(var t=0;t<e.length;t++)try{var n=e[t];o.info("exit, close stream = ",n.id),d.emedia.stopTracks(n)}catch(e){o.error(e)}o.warn("finally. all clean.")},_onRoleUpdate:function(e,t){o.info("Role ",e," <-",this.role),o.info(t),this.role=e,this.roleToken=t,this.onRoleUpdate&&this.onRoleUpdate(e,t)},onExit:function(e,t,n){var r=this;if(e&&(r._cver=e),t!=r.getMemberId()){var a=r._cacheMembers[t];a&&(a.res&&a.res.vcodes&&a.res.vcodes.length>0&&i.forEach(a.res.vcodes,(function(e,t){r.supportVCodes[t]--})),r._onRemoveMember(a,n),r.onEvent(new s.Hangup({reason:n,parnter:a})))}else{o.warn("Me exit. ",n,t);try{r.closed||r.close(n)}catch(e){r.onEvent(new s.Hangup({reason:n,self:{id:r._memberId}})),r.onMeExit&&r.onMeExit(n),o.warn(e)}}},onPub:function(e,t,n){this._cacheMembers[t]||o.error("No found member. when pub");var r=this.newStream(n),s=this._cacheStreams[n.id];if(e&&(this._cver=e),s&&r.sver!==s.sver)return o.info("Onpub. the steam ",s.id," republish. sver ",s.sver,r.sver),!r||r.aoff===s.aoff&&r.voff==s.voff||this.onStreamControl(void 0,n.id,r.voff,r.aoff),i.extend(s,r),void this._onRepublishStream(s);var a=r;a.updateAttributes({owner:this._cacheMembers[t]}),this._cacheStreams[n.id]=a,this._onAddStream(this.newStream(a));this.newStream(a).id;return a},onUnpub:function(e,t,n){var i=this._cacheStreams[n];this._onRemovePubstream(this._cacheMembers[t],i),e&&(this._cver=e)},onClose:function(e,t,n){try{this.close(n||0)}finally{this.onConfrClose&&this.onConfrClose(t,n)}},__getWebrtcFor:function(e){var t=this._cacheStreams[e]&&this._cacheStreams[e]._webrtc;return t&&t.getRtcId()},_getWebrtc:function(e){return this._cacheStreams[e]&&this._cacheStreams[e]._webrtc},_updateRemoteStream:function(e,t){e.located()&&2===e.type?d.emedia.enableAudioTracks(t,!0):d.emedia.enableAudioTracks(t,!(e.aoff||e.subArgs&&!1===e.subArgs.subSAudio)),d.emedia.enableVideoTracks(t,!(e.voff||e.subArgs&&!1===e.subArgs.subSVideo))},onStreamControl:function(e,t,n,i,o){var r=this._cacheStreams[t];r.updateAttributes({voff:n,aoff:i});var s=r._webrtc;s&&s._remoteStream&&this._updateRemoteStream(r,s._remoteStream);var a=this.newStream(r);this.onUpdateStream&&this.onUpdateStream(a,new a.Update({voff:n,aoff:i})),e&&(this._cver=e),o&&r.updateAttributes({sver:o})},aoff:function(e,t,n){var i=this.__getWebrtcFor(e.id);if(!i)throw o.error("pubS not publish",e.id),"pubS not publish"+e.id;this._linkedStreams[e.id].updateAttributes({aoff:t}),e.updateAttributes({aoff:t});var r=this.newMessage().setOp(400).setRtcId(i).setVoff(e.voff).setAoff(t);this.postMessage(r,n),this.onUpdateStream&&this.onUpdateStream(e,new e.Update({aoff:t}))},voff:function(e,t,n){var i=this.__getWebrtcFor(e.id);if(!i)throw o.error("pubS not publish",e.id),"pubS not publish"+e.id;this._linkedStreams[e.id].updateAttributes({voff:t}),e.updateAttributes({voff:t});var r=this.newMessage().setOp(400).setRtcId(i).setVoff(t).setAoff(e.aoff);this.postMessage(r,n),this.onUpdateStream&&this.onUpdateStream(e,new e.Update({voff:t}))},startRecord:function(e,t){var n=this,r=e.rtcId,s=n.newMessage().setOp(500).setRtcId(r).setFlag(1);n.postMessage(s,(function(s){o.warn("record ",r,s.result,s.msg),t&&t(0===s.result),0===s.result&&(n._records[e.id]=i.extend(!1,{},e))}))},stopRecord:function(e,t){var n=e.rtcId,r=this.newMessage().setOp(500).setRtcId(n).setFlag(0);this.postMessage(r,(function(e){o.warn("stop record ",n,e.result,e.msg),t&&t(0===e.result)})),this._records[e.id]&&i.removeAttribute(this._records,e.id)},onMembers:function(e,t){var n=this,o=[];i.forEach(n._cacheMembers,(function(e,n){t[e]||o.push(n)}));var r=[];i.forEach(t,(function(e,t){(t.name&&t.name!=n.memName||!t.name&&e!=n.getMemberId())&&(n._cacheMembers[e]||r.push(t),n._cacheMembers[e]&&i.extend(n._cacheMembers[e],t))})),i.forEach(r,(function(e,t){n.onEnter(void 0,t)})),e&&(n._cver=e)},onStreams:function(e,t){var n=this,o=[];i.forEach(n._cacheStreams,(function(e,n){n.located()||t[e]||o.push(n)})),i.forEach(o,(function(e,t){n.onUnpub(void 0,t.memId,t.id)}));var r=[];i.forEach(t,(function(e,t){(t.memName&&t.memName!=n.memName||!t.memName&&t.memId!=n.getMemberId())&&(n._cacheStreams[e]||r.push(t),n._cacheStreams[e]&&i.extend(n._cacheStreams[e],t))})),i.forEach(r,(function(e,t){n.onPub(void 0,t.memId,t)})),i.forEach(n._cacheStreams,(function(e,o){var r;o.located()||(r=t[e]),!r||r.aoff===o.aoff&&r.voff==o.voff||n.onStreamControl(void 0,e,r.voff,r.aoff),r&&r.sver!==o.sver&&(i.extend(o,r),n._onRepublishStream(o))})),e&&(n._cver=e)},_onRemoveMember:function(e,t){var n=this;o.info("remove",e,t);var r=[];i.forEach(n._cacheStreams,(function(t,n){(n.memId||n.owner&&n.owner.id)===e.id&&r.push(n)})),i.forEach(r,(function(e,i){n._onRemovePubstream(i.owner,i,t)})),i.removeAttribute(n._cacheMembers,e.id),n.onRemoveMember&&n.onRemoveMember(e,t)},_onAddStream:function(e){o.info("add stream ",e.id),o.debug("add stream ",e);this.onAddStream(e)},_onRemovePubstream:function(e,t,n){var o=this;if(t&&0!=t.id)try{var r=i.removeAttribute(o._mediaMeters,t.id);r&&r._finally()}finally{!function(e){if(2===e.type&&(i.removeAttribute(o.audioMixers,e.id),e.remotePlayAudioObject&&document.body.removeChild(e.remotePlayAudioObject)),n||(n="Unpub"),e&&!e.closeReason&&e.updateAttributes({closeReason:n}),o.unsubscribeStream(e.id),i.removeAttribute(o._cacheStreams,e.id),o._streamAutomators&&i.removeAttribute(o._streamAutomators,e.id),o._monitSoundChanagedStreams&&i.removeAttribute(o._monitSoundChanagedStreams,e.id),o.onRemoveStream){e=o.newStream(e);o.onRemoveStream(e)}}(t)}},_onRepublishStream:function(e){if(!this._ices[e.rtcId]&&!d.emedia.subscribed(e)||this._maybeNotExistStreams[e.id])this.onUpdateStream(e);else{this.unsubscribeStream(e.id);this.createWebrtcAndSubscribeStream(e.id,{onGotRemote:function(e){}})}},_onRecvRemoteMessage:function(e,t,n){o.debug("Recv remote message",e,t);var i,r=this._cacheMembers[e];try{i=JSON.parse(t)}catch(e){}this.onRecvRemoteMessage&&this.onRecvRemoteMessage(r||e,i||t,n)},_onSoundChanage:function(e,t,n){d.emedia.config._printSoundData&&o.info("Stream id "+t.id+", meter "+(n&&n.instant.toFixed(2)+" "+n.slow.toFixed(2)+" "+n.clip.toFixed(2)+" "+(n.trackAudioLevel||"--")+" "+(n.trackTotalAudioEnergy||"--"))),n||(n={instant:0,slow:0,clip:0}),d.emedia.config.logVolumeWhenInstantGE&&d.emedia.config.logVolumeWhenInstantGE>0&&n.instant>=d.emedia.config.logVolumeWhenInstantGE&&n.instant<3*d.emedia.config.logVolumeWhenInstantGE&&o.info("Stream id "+t.id+", webrtc = "+(t._webrtc?t._webrtc.getRtcId():"null")+", media streamId = "+(t.getMediaStream()?t.getMediaStream().id:"null")+", instant >= "+d.emedia.config.logVolumeWhenInstantGE+", meter instant="+n.instant+", slow="+n.slow+", clip="+n.clip);0===n.instant&&(n.instant=n.trackAudioLevel||n.trackTotalAudioEnergy||0),this.onSoundChanage(e,t,n),this._service._judgeTalking(n)&&this.onTalking(e,t,n)},onAddMember:function(e){c._onMemberJoined(e)},onRemoveMember:function(e,t){c.onMemberExited(e,t)},onAddStream:function(e){c.onStreamAdded(e)},onRemoveStream:function(e){c.onStreamRemoved(e)},_onConfrAttrsUpdated:function(e){c.onConfrAttrsUpdated(e)},onUpdateStream:function(e,t){c.onMediaChanaged(e,t)},onRecvRemoteMessage:function(e,t){},onSoundChanage:function(e,t,n){c.onSoundChanage(e,t,n)},onTalking:function(e,t,n){},onRoleUpdate:function(e,t){c.onRoleChanged(e,t)},onMeExit:function(e){c.onConferenceExit(e)}});e.exports=u},function(e,t,n){var i=n(0),o=i.tagLogger("Member"),r=n(1),s=n(3),a=i.getEnvInfo().global;e.exports=i.prototypeExtend({__init__:function(){if(!this._session)throw o.error("Require session"),"Require session";this.closed=!1,this._ices={},this.supportVCodes={},this.audioMixers={}},reflushSupportVCodes:function(e){var t=this;t.supportVCodes={},t._orderVCodes=e,e&&0!=e.length?i.forEach(e,(function(e,n){t.supportVCodes[n]=1})):o.warn("Not config support vcodes")},getOptimalVideoCodecs:function(){var e=0;i.forEach(this._cacheMembers,(function(){e++}));for(var t,n=0,o=0;o<this._orderVCodes.length;o++){var r=this._orderVCodes[o];if(0==n&&(n=this.supportVCodes[r]),this.supportVCodes[r]>e)return r;this.supportVCodes[r]>n&&(n=this.supportVCodes[r],t=r)}return t},setMemberId:function(e){this._memberId=e},getMemberId:function(){return this._memberId||this.id},createWebrtc:function(e,t){var n=this;e||(e={}),i.extend(e,{_rebuildCount:t||0}),!0===n._service.useRTCCfg&&n.__rtc_cfg?e.iceServerConfig=i.extend(!0,{},n.__rtc_cfg):i.isPlainObject(n._service.useRTCCfg)&&(e.iceServerConfig=i.extend(!0,{},n._service.useRTCCfg));var a=new s({confrAttendee:n,useIp:n.ip,onIceStateChange:function(e){var t=e;o.debug("evt.target ice state",t);try{if("failed"==t)return n.onEvent(new r.ICEConnectFail({webrtc:a})),void(a.onEvent&&a.onEvent(new r.ICEConnectFail({webrtc:a})));if("connected"==t)return n.onEvent(new r.ICEConnected({webrtc:a})),void(a.onEvent=null);if("closed"==t)return n.onEvent(new r.ICEClosed({webrtc:a})),void(a.onEvent&&a.onEvent(new r.ICEClosed({webrtc:a})));if("disconnected"==t)return n.onEvent(new r.ICEDisconnected({webrtc:a})),void(a.onEvent&&a.onEvent(new r.ICEDisconnected({webrtc:a})))}finally{n._onIceStateChange&&n._onIceStateChange(a,e)}},onIceCandidate:function(e){n._onIceCandidate&&e&&n._onIceCandidate(a,e)},onGotRemoteStream:function(e){o.info("got stream.",a._rtcId,a.__id,e),a.onGotMediaStream&&a.onGotMediaStream(e),n.onEvent(new r.ICERemoteMediaStream({webrtc:a}))},onAddIceCandidateError:function(e){n.onEvent(new r.AddIceCandError({webrtc:a,event:e}))},onSetSessionDescriptionError:function(e){o.warn("onSetSessionDescriptionError : Failed to set session description: "+e.toString()),n.onEvent&&n.onEvent(new r.ICEConnectFail({webrtc:a,event:e}))},onCreateSessionDescriptionError:function(e){o.warn("Failed to create session description: "+e.toString()),n.onEvent&&n.onEvent(new r.ICEConnectFail({webrtc:a,event:e}))}},e);return n._ices||(n._ices={}),n._ices[a.getRtcId()]&&n._howDoWebrtcWhenCrtExsitsWebrtc(a),n._ices[a.getRtcId()]=a,n._ices[a.__id]=a,n._iceCreateRtcPeerConnection(a.getRtcId()),o.debug("create rtc ",a),a},_howDoWebrtcWhenCrtExsitsWebrtc:function(e){this.closeWebrtc(e.getRtcId(),!0,!1)},connect:function(e,t){this._session.connect(e,t)},connected:function(){return this._session.connected()},newMessage:function(e){var t=this,n=t._session.newMessage(e);return n.post=function(e,n){t.postMessage(this,e,n)},n},message:function(e){var t=this,n=t._session.newMessage(e);return n.post=function(e,n){t.postMessage(this,e,n)},n},postMessage:function(e,t,n){try{e.sessId||(e.sessId=this._session._sessionId),this._session.postMessage(e,t,n)}catch(n){t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"post message. exception"}),o.warn(n)}},onEvent:function(e){},_onIceStateChange:function(e,t){o.info(e.getRtcId(),t),this.onEvent(new r.ICEChanage({webrtc:e,state:t}))},_onIceCandidate:function(e,t){var n,o=this;i.isArray(t)?n=t:(n=[]).push(t);var s=o.newMessage().setOp(105).setRtcId(e.getRtcId()).setCands(n);o.postMessage(s,(function(e){0==e.result||o.onEvent(new r.RspFail({request:s,response:e}))}))},_initC:function(e,t,n,s,a,c){var d=this;if(t&&t.rtcId!==e.getRtcId())throw o.error("stream and webrtc rtcId not equal."),"stream and webrtc rtcId not equal.";var u=d.newMessage().setOp(102).setRtcId(e.getRtcId()).setSdp(n).setSubSId(s);e.subArgs&&i.extend(u,e.subArgs),t&&t.located()&&u.setPubS(t),d.postMessage(u,(function(n){if(0!=n.result)return d.onEvent(new r.RspFail({request:u,response:n})),void(a&&a(new r.RspFail({request:u,response:n,hidden:!0===n.retrying})));t&&!t.id&&n.streamId&&t.updateAttributes({id:n.streamId});try{c&&c()}catch(e){o.warn(e)}n.sdp&&d.ansC(e.getRtcId(),n.sdp,n.cands),console.log("_member postMessage"),n.mems&&d.onMembers&&d.onMembers(n.cver,n.mems),n.streams&&d.onStreams&&d.onStreams(n.cver,n.streams)}))},_acptC:function(e,t,n){var i=this,o=i.newMessage().setOp(104).setRtcId(e.getRtcId()).setSdp(t);i.postMessage(o,(function(e){if(0!=e.result)return i.onEvent(new r.RspFail({request:o,response:e})),void(n&&n(new r.RspFail({request:o,response:e})))}))},_ansCAndPubstream:function(e,t,n,s,a){var c=this,d=c.newMessage().setOp(106).setRtcId(e.getRtcId()).setSdp(n);e.subArgs&&i.extend(d,e.subArgs),t&&t.located()&&(t=i.extend({},t),i.removeAttribute(t,"mutedMuted"),i.removeAttribute(t,"_located"),d.setPubS(t)),c.postMessage(d,(function(e){if(0!=e.result)return c.onEvent(new r.RspFail({request:d,response:e})),void(s&&s(new r.RspFail({request:d,response:e,hidden:!0===e.retrying})));t&&!t.id&&e.streamId&&t.updateAttributes({id:e.streamId});try{a&&a()}catch(e){o.warn(e)}}))},_ansC:function(e,t,n){var i=this,o=i.newMessage().setOp(106).setRtcId(e.getRtcId()).setSdp(t);i.postMessage(o,(function(e){if(0!=e.result)return i.onEvent(new r.RspFail({request:o,response:e})),void(n&&n(new r.RspFail({request:o,response:e})))}))},_termC:function(e,t,n){var i=this,o="string"==typeof e?e:e.getRtcId(),s=i.newMessage().setOp(107).setRtcId(o).setEndReason(t);i.postMessage(s,(function(e){if(0!=e.result)return i.onEvent(new r.RspFail({request:s,response:e})),void(n&&n(new r.RspFail({request:s,response:e})))}))},_iceCreateRtcPeerConnection:function(e){this._ices[e].createRtcPeerConnection(),o.debug("create rtc peer connection",e)},doOffer:function(e,t,n){this._ices[e].createOffer((function(e){t(e)}))},offerCall:function(e,t,n,i,o){var r=this,s=r._ices[e];s.createOffer((function(e){r._initC&&r._initC(s,t,e,n,i,o)}))},accept:function(e,t){var n=this,i=n._ices[e];i.createPRAnswer((function(e){n._acptC&&n._acptC(i,e,t)}))},answerCall:function(e,t,n,i){var o=this,r=o._ices[e];r.createAnswer((function(e){o._ansCAndPubstream&&o._ansCAndPubstream(r,t,e,n,i)}))},answer:function(e,t){var n=this,i=n._ices[e];i.createAnswer((function(e){n._ansC&&n._ansC(i,e,t)}))},onTcklC:function(e,t){},onAcptC:function(e,t,n){},onAnsC:function(e,t,n){},_addIceCandidate:function(e,t){if(e&&0!=e.length){var n=this._ices[t];n&&n.addIceCandidate(e)}else o.warn("drop cands",e)},closeWebrtc:function(e,t,n){var r=this,s=r._ices[e];if(i.forEach(r._cacheStreams,(function(t,n){if(n.rtcId===e&&!n.located())try{var s=i.removeAttribute(r._mediaMeters,t);s&&s._finally()}catch(e){o.warn(e)}n.rtcId===e&&2===n.type&&i.removeAttribute(r.audioMixers,n.id)})),!s||s.closed)return o.warn("Webrtc not exsits or closed",s&&s.closed),n&&s&&i.forEach(r._cacheStreams,(function(t,n){n.rtcId===e&&(i.removeAttribute(r._linkedStreams,t),o.warn("Webrtc close, remvoe from _linkedStreams",t))})),void(n||r._termC(e,0));if(r._records){i.forEach(r._records,(function(t,n){n.rtcId===e&&function(e){try{r.stopRecord(e)}catch(e){o.warn(e)}finally{i.removeAttribute(r._records,e.id)}}(n)}))}try{n||s&&r._termC(s,t&&s._localStream?-10:0)}finally{s&&s.close(t),s&&r.onWebrtcTermC&&r.onWebrtcTermC(s),t||s&&i.forEach(r._cacheStreams,(function(t,s){s.rtcId===e&&(s.located()&&(a.emedia.stopTracks(s._localMediaStream),s&&!s.closeReason&&s.updateAttributes({closeReason:"WebrtcClose"}),r._cacheStreams[t]&&r._linkedStreams[t]&&r.onRemoveStream(s),i.removeAttribute(r._cacheStreams,t),r._streamAutomators&&i.removeAttribute(r._streamAutomators,t),r._monitSoundChanagedStreams&&i.removeAttribute(r._monitSoundChanagedStreams,t),o.info("Webrtc close. Remove stream",t,". from cache")),n&&(i.removeAttribute(r._linkedStreams,t),o.info("Webrtc close. Remove stream",t,". from _linkedStreams")))}))}return s},__close:function(e){o.warn("closing, reason = ",e);if(!this.closed){if(this.closed=!0,this.__getCopyInterval&&(clearInterval(this.__getCopyInterval),o.warn("Stop interval get copy")),this._ices)for(var t in this._ices)this.closeWebrtc(t,!1);var n=this.newMessage().setOp(201).setReason(e||0);this.postMessage(n)}},exit:function(e){var t=this;e?(e&&t._closeMyConfr(11),setTimeout((function(){t.close(0)}),100)):t.close(0)},_closeMyConfr:function(e){var t=this.newMessage().setOp(204).setReason(e||0);this.postMessage(t,(function(e){o.warn("Close confr ",e.result,e.msg)}))},close:function(e,t){var n=this;if(!n.closed)try{i.forEach(n._cacheStreams||{},(function(e,t){t.located()&&t._localMediaStream&&a.emedia.stopTracks(t._localMediaStream)})),n.__close(e),i.forEach(n._cacheStreams,(function(e,t){n.onRemoveStream(t)})),i.forEach(n._cacheMembers,(function(e,t){n.onRemoveMember(t)}))}finally{try{setTimeout((function(){n._session&&n._session.close(e)}),500),n.onEvent(new r.Hangup({reason:e,failed:t,self:{id:n._memberId}})),n.onMeExit&&n.onMeExit(e,t)}catch(e){o.error(e)}finally{n._onFinally&&n._onFinally()}}},webrtcState:function(e){return this._ices[e].iceConnectionState()},_iceSetRemoteSDP:function(e,t){this._ices[t].setRemoteDescription(e)},setLocalStream:function(e,t){this._ices[t].setLocalStream(e)},onWebrtcTermC:function(e){}})},function(e,t,n){var i=n(0),o=i.tagLogger("Handler"),r=n(1),s=i.getEnvInfo().global,a=i.prototypeExtend({onEvent:function(e){var t=this;function n(){try{t.handleEvent(e)}catch(e){o.warn(e)}}if(e&&o.info("[EVT]",e.message(),e.hidden||""),e instanceof r.ServerRefuseEnter&&e.failed&&-95270===e.failed&&(e.failed=-9527),e instanceof s.emedia.event.StreamState&&e.stream&&e.stream.located())n();else try{e.hidden||t.onNotifyEvent&&t.onNotifyEvent(e)}finally{n()}},handleEvent:function(e){console.log("evt",e);var t=this;if(e instanceof r.RecvResponse)t._onRecvResponse(e);else if(e instanceof r.ServerRefuseEnter)o.warn("Server refuse, ",e.failed,e.msg),t.onServerRefuseEnter(e);else if(e instanceof r.NetworkChanaged)o.warn("Network chanaged, ",e.preIp,e.nowIp),t.onNetworkChanaged(e);else if(e instanceof r.EnterFail)o.warn("Enter fail, result = ",e.failed),t.onEnterFail();else if(e instanceof r.WSClose)t.onWSClose();else if(e instanceof r.WSConnected)o.warn("Websocket connected");else if(e instanceof r.ICEConnected){var n=e.webrtc;t.onICEConnected(n)}else if(e instanceof r.ICEConnectFail){n=e.webrtc;t.onICEConnectFail(n)}else if(e instanceof r.ICEDisconnected){n=e.webrtc;t.onICEDisconnected(n)}else if(e instanceof r.ICEClosed){n=e.webrtc;t.onICEClosed(n)}else if(e instanceof r.ICERemoteMediaStream)t.onICERemoteMediaStream(e.webrtc);else if(e instanceof r.PushSuccess){t._cacheStreams[e.stream.id]=t._linkedStreams[e.stream.id]=e.stream;var a=t.newStream(e.stream);if(e.hidden&&!t._maybeNotExistStreams[e.stream.id]&&!a.isRepublished)return void t._onAddStream(a);s.emedia._yetGetUserMedia=!0;try{!0!==e.hidden&&a&&t.onUpdateStream(a,new a.Update({voff:a.voff,aoff:a.aoff,mediaStream:a.getMediaStream()}))}finally{s.emedia.isSafari&&i.forEach(t._cacheStreams,(function(e,n){!0===n._autoSubWhenPushStream&&(i.removeAttribute(n,"_autoSubWhenPushStream"),t.createWebrtcAndSubscribeStream(n.id))}))}}else if(e instanceof r.SubSuccess)t._linkedStreams[e.stream.id]=e.stream,e.stream.updateAttributes({_zoom:1});else if(e instanceof r.PushFail){if(!0!==e.hidden){var c=i.removeAttribute(t._linkedStreams,e.stream.id);if(o.warn("PushFail remove from _linkedStreams",e.stream.id,c),c){a=t.newStream(e.stream);t.onRemoveStream(a)}}}else if(e instanceof r.SubFail){if(!0!==e.hidden)i.removeAttribute(t._linkedStreams,e.stream.id),o.warn("SubFail remove from _linkedStreams",e.stream.id),(a=t.newStream(e.stream)).updateAttributes({rtcId:void 0,_webrtc:void 0,mediaStream:void 0}),t.onUpdateStream(a,new a.Update(a))}else if(e instanceof r.SubFailNotSupportVCodes){var d=e.stream;o.warn("Rtc donot support pub VCodes. close. sub fail.",d.rtcId," -> ",d.id);try{t.onNotSupportPublishVideoCodecs&&t.onNotSupportPublishVideoCodecs(d)}catch(e){o.warn(e)}}else if(e instanceof r.EnterSuccess)t.onEnterSuccess();else if(e instanceof r.SwitchVCodes){d=e.stream;var u=e.useVCodes;n=d._webrtc;if(o.warn("Rtc switch VCodes. ",d.id,u),u&&0!=u.length||o.warn("Rtc switch VCodes. error! useVCodes is empty ",d.id,u),n&&n.optimalVideoCodecs){if("string"==typeof n.optimalVideoCodecs&&n.optimalVideoCodecs==u[0])return void o.warn("Rtc switch VCodes. igrone . useVCodes == optimalVideoCodecs ",d.id,n._rtcId,u);if(i.isArray(n.optimalVideoCodecs)&&n.optimalVideoCodecs.length>0&&n.optimalVideoCodecs[0]==u[0])return void o.warn("Rtc switch VCodes. igrone ddd . useVCodes == optimalVideoCodecs ",d.id,n._rtcId,u)}d.updateAttributes({optimalVideoCodecs:u}),n&&t.closeWebrtc(n.getRtcId(),!0),setTimeout((function(){d.updateAttributes({iceRebuildCount:1}),t.iceRebuild(d),o.warn("Rtc switch VCodes. iceRebuild end.",d.id,u)}),300)}},_onRecvResponse:function(e){var t=e.request,n=e.response;if(t&&n&&200!==t.op&&1002!==t.op&&0!==n.result){o.warn("Server refuse. when request = ",t);var i=e.failed;switch(i){case-9527:case-95270:break;case-500:case-502:case-504:case-508:case-510:this.close(4,i);break;case-506:this.close(11,i);break;case-501:this.close(11,i)}}},onServerRefuseEnter:function(e){var t=e.failed;switch(t){case-9527:case-95270:this.close(4,-9527);break;case-500:case-502:case-504:case-508:case-510:this.close(4,t);break;case-506:this.close(11,t);break;default:this.close(2)}},onEnterFail:function(){this.__getCopyInterval&&clearInterval(this.__getCopyInterval)},onNetworkChanaged:function(e){var t=this,n=e.nowIp;s.emedia.config.rebuildPeerConnectionWhenNetworkChanaged&&setTimeout((function(){var e={};i.forEach(t._cacheStreams,(function(i,r){if(!t._maybeNotExistStreams[i]&&r._webrtc){var s=r._webrtc;e[r.rtcId]||(s.closed||"string"!=typeof s.useIp||s.useIp===n||(o.warn("network chanage. webrtc will rebuild.",s._rtcId,s.__id),t.onICEClosed(s)),e[r.rtcId]=!0)}}))}),100)},onEnterSuccess:function(){var e=this;setTimeout((function(){e._failIcesRebuild()}),50),e.getCopyIntervalMillis&&e.getCopyIntervalMillis>0&&(o.warn("Run interval get copy. interval = ",e.getCopyIntervalMillis),e.__getCopyInterval&&clearInterval(e.__getCopyInterval),e.__getCopyInterval=setInterval((function(){e._session.connected()?e._sysCopy.apply(e):(o.warn("Warn! cannot get copy. cause offline."),e.__getCopyInterval&&clearInterval(e.__getCopyInterval))}),e.getCopyIntervalMillis)),e.getMediaMeterIntervalMillis&&e.getMediaMeterIntervalMillis>0&&e._intervalGetMediaMeters()},_intervalGetMediaMeters:function(){var e=this;!function t(){e.__getMediaMetersIntervalFlag&&s.emedia.cancelAnimationFrame(e.__getMediaMetersIntervalFlag),e.getMediaMeterIntervalMillis?e.__getMediaMetersIntervalFlag=s.emedia.requestAnimationFrame((function(n){"function"==typeof s.emedia.AudioContext&&e._flushMediaMetersByAudioContext.apply(e),!1===e.closed&&t()}),e.getMediaMeterIntervalMillis):o.warn("Ontalking closed. please use getMediaMeterIntervalMillis")}()},_flushMediaMetersByAudioContext:function(){var e=this;i.forEach(e._cacheStreams,(function(t,n){e._monitSoundChanagedStreams&&!e._monitSoundChanagedStreams[t]||"0"!=n.id&&e._updateMetersOrNewOne.call(e,t,n)}));var t=[];i.forEach(e._mediaMeters,(function(n,i){var o=e._cacheStreams[n];o&&e._updateMetersOrNewOne.call(e,n,o),o||t.push(n)})),i.forEach(t,(function(t,n){i.removeAttribute(e._mediaMeters,n)}))},_updateMetersOrNewOne:function(e,t){var n=this,o=n._mediaMeters[e];if(!(2!==t.type||t.located()||t.subArgs&&t.subArgs.subSAudio)){var r=n._oneAudioMixers();if(!r||o&&o._webrtc&&r._webrtc.__id!=o._webrtc.__id)return o&&o._finally(),i.removeAttribute(n._mediaMeters,e),void n._onSoundChanage.call(n,t.owner,t)}return o&&o._streamCreateId===t.__create_id&&o.__mediaSoundMeter.__worked?(o.onSoundMeters((function(e){n._onSoundChanage.call(n,t.owner,t,e)})),o):(o&&(o._streamCreateId!==t.__create_id||o.__mediaSoundMeter.__worked)&&(o&&o._finally(),i.removeAttribute(n._mediaMeters,e),n._onSoundChanage.call(n,t.owner,t)),t.aoff?void 0:((o=n._newMediaMeters(t))&&(n._mediaMeters[e]&&n._mediaMeters[e]._finally(),n._mediaMeters[e]=o),o))},_newAudioContext:function(){if(s.emedia.__usingWebAudio)return s.emedia.__audioContext},_newMediaMeters:function(e){var t;if(2===e.type&&e.subArgs&&e.subArgs.subSAudio&&e._webrtc&&e._webrtc.getRemoteStream())return new e.StreamSoundMeter({_stream:e,_mediaStream:e._webrtc.getRemoteStream(),_webrtc:e._webrtc,__audioContext:this._newAudioContext()});if(2===e.type&&e.located())return new e.StreamSoundMeter({_stream:e,_mediaStream:e._localMediaStream,__audioContext:this._newAudioContext()});if(2===e.type&&!e.located()){var n=this._oneAudioMixers();if(!n||!n._webrtc||n._webrtc.closed)return;if(n&&(void 0===n._remoteMediaSoundMeters||!n._remoteMediaSoundMeters.__worked)&&n._webrtc&&n._webrtc.getRemoteStream()&&(n._remoteMediaSoundMeters=new n.MediaSoundMeter({_mediaStream:n._webrtc.getRemoteStream(),__audioContext:this._newAudioContext()})),!n._remoteMediaSoundMeters)return;return new e.StreamSoundMeter({_stream:e,_webrtc:n._webrtc,__mediaSoundMeter:n._remoteMediaSoundMeters})}return!e.aoff&&(t=e.getMediaStream())?new e.StreamSoundMeter({_stream:e,_mediaStream:t,__audioContext:this._newAudioContext()}):void 0},_oneAudioMixers:function(){var e=this._cacheStreams[0];if(e&&e._webrtc&&!e._webrtc.closed)return e;for(var t in this.audioMixers){var n=this.audioMixers[t];if(n.located())return n}},onWSClose:function(){this.__getCopyInterval&&clearInterval(this.__getCopyInterval),o.info("Websocket closed.")},onICEDisconnected:function(e){var t=this;t.__networkWeakInterval&&clearTimeout(t.__networkWeakInterval),t.__networkWeakInterval=setTimeout((function(){t.onNetworkWeak&&t.onNetworkWeak()}),1e3),i.forEach(t._linkedStreams,(function(n,r){r.rtcId==e.getRtcId()&&(t._maybeNotExistStreams[n]||(t._maybeNotExistStreams[n]=i.extend({},r)).updateAttributes({iceRebuildCount:1}),o.info("Stream maybe not exist. caused by disconnected",r.id))}))},onICEConnectFail:function(e){var t=this;for(var n in t._linkedStreams){var a=t._linkedStreams[n];if(a.rtcId==e.getRtcId()){if(a._webrtc&&a._webrtc.__id!==e.__id){o.warn("Stream use other webrtc rtcId = ",a.rtcId,", id: ",a._webrtc.__id,e.__id);continue}var c;if((c=t._maybeNotExistStreams[n])||(c=t._maybeNotExistStreams[n]=i.extend({},a)).updateAttributes({iceRebuildCount:1}),c){var d=new r.StreamState({stream:c});d.iceFail(),t.onEvent(d)}if(o.info("ice fail. webrtc = ",e.getRtcId()," problem stream is ",c.iceRebuildCount,c.id),c.iceRebuildCount>s.emedia.config.iceRebuildCount)o.info("ice fail. webrtc = ",e.getRtcId()," rebuild fail. problem stream is ",c.id),c.located()?t.onEvent(new r.PushFail({stream:a,cause:"pub ice rebuild failed."})):t.onEvent(new r.SubFail({stream:a,cause:"sub ice rebuild failed."})),t.closeWebrtc(e.getRtcId(),!1);else{var u=t._records[c.id];c._localMediaStream?o.info("ice fail. webrtc = ",e.getRtcId()," will rebuild. remain local stream. ",c.id):o.info("ice fail. webrtc = ",e.getRtcId()," will rebuild.",c.id),t.closeWebrtc(e.getRtcId(),!0),u&&(t._records[c.id]=u),function(e){setTimeout((function(){t.iceRebuild(e)}),s.emedia.config.iceRebuildIntervalMillis)}(c),o.info("ice fail. webrtc = ",e.getRtcId()," will rebuilding. problem stream is ",c.id)}2===a.type&&i.removeAttribute(t.audioMixers,a.id)}}},onICEClosed:function(e){if(e.closed){o.warn("Webrtc will be removed. by __id = ",e.__id,", rtcId = ",e.getRtcId());var t=i.removeAttribute(this._ices,e.__id);t?o.warn("Webrtc removed. by id = ",t.__id,", rtcId = ",t.getRtcId()):o.warn("Webrtc removed. by id = ",e.__id,", rtcId = ",e.getRtcId());var n=this._ices[e.getRtcId()];n&&n.__id===t.__id&&(t=i.removeAttribute(this._ices,e.getRtcId()),o.warn("Webrtc removed. by rtcId = ",t.getRtcId(),", __id = ",t.__id))}else o.info("ICE self closed. not allow. will rebuild",e.getRtcId()),this.onICEConnectFail(e)},onICEConnected:function(e){var t=this;i.forEach(t._cacheStreams,(function(n,s){if(s.rtcId==e.getRtcId()){if(s.updateAttributes({finalVCodeChoices:e.finalVCodeChoices}),t._maybeNotExistStreams[n]){i.removeAttribute(t._maybeNotExistStreams,s.id),t._linkedStreams[n]=s,o.info("ice reconnected. webrtc = ",e.getRtcId(),"will update stream = ",s.id);var a=t._records[s.id];a&&a.rtcId!==s.rtcId&&(t.startRecord(s),o.warn("Re record. for ",s.id,", after rebuild ice.",a.rtcId,"->",s.rtcId))}else o.info("ice connected. webrtc = ",e.getRtcId(),s.id),s.located()&&t.onEvent(new r.PushSuccess({stream:s})),s.located()||t.onEvent(new r.SubSuccess({stream:s}));2===s.type&&(t.audioMixers[s.id]=s)}}))},onICERemoteMediaStream:function(e){var t=this;i.forEach(t._cacheStreams,(function(n,i){if(i.rtcId==e.getRtcId()&&(!i.located()||2===i.type)){var o=e.getRemoteStream();if(t._updateRemoteStream(i,o),i.onGotRemoteMediaStream)i.onGotRemoteMediaStream.call(i,o);else(i=t.newStream(i)).updateAttributes({mediaStream:e.getRemoteStream()}),t.onUpdateStream(i,new i.Update({mediaStream:i.mediaStream}))}}))},_failIcesRebuild:function(){var e=this;i.forEach(e._maybeNotExistStreams,(function(t,n){setTimeout((function(){e.iceRebuild(n)}),100)}))},iceRebuild:function(e){return this.connected()?this._linkedStreams[e.id]&&this._cacheStreams[e.id]?void(e.iceRebuildCount>s.emedia.config.iceRebuildCount?(o.info("ice rebuild fail. count too many. stream is ",e.id),e.located()?this.onEvent(new r.PushFail({stream:e,cause:"pub ice rebuild failed."})):this.onEvent(new r.SubFail({stream:e,cause:"sub ice rebuild failed."}))):this.connected()?(o.info("ice try rebuild. count",e.iceRebuildCount,". stream is ",e.id),this.rebuildIce(e),e.iceRebuildCount++):o.warn("ice rebuild. stop. cause by not websocket disconnect",e.id)):(o.info("ice rebuild fail. it yet closed. stream is ",e.id,e.rtcId),i.removeAttribute(this._maybeNotExistStreams,e.id),i.removeAttribute(this._linkedStreams,e.id),void o.warn("iceRebuild, remvoe from _linkedStreams",e.id)):(e.updateAttributes({iceRebuildCount:1}),void o.warn("Websocket disconnect. waiting. rebuild count reset",e.iceRebuildCount,e.id))},rebuildIce:function(e){this._cacheStreams[e.id]?(o.warn("Begin rebuild ice ",e.iceRebuildCount,e.id),e.located()?(e.updateAttributes({isRepublished:!0}),this.push(e,void 0,void 0,!0)):this.createWebrtcAndSubscribeStream(e.id),o.warn("Finish rebuild ice ",e.iceRebuildCount,e.id,this._cacheStreams[e.id].rtcId)):o.warn("Begin rebuild ice. not found stream at local",e.iceRebuildCount,e.id)},_sysCopy:function(){var e=this,t=e.newMessage().setOp(1e3).setCver(e._cver||0);e.postMessage(t,(function(t){0==t.result?(e._cver||0)<t.cver&&(e._cver=t.cver,console.log("EventHandler _sysCopy"),o.info("Got copy success.")):o.warn("Get copy fail. result = ",t.result)}))}});e.exports=a}])}));